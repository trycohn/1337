#!/bin/bash

# üéØ –û–ü–¢–ò–ú–ê–õ–¨–ù–´–ô —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
# ‚úÖ –†–µ—à–∞–µ—Ç: —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü—ã user_tournament_stats + —É–ª—É—á—à–µ–Ω–Ω—ã–π UX
# ‚≠ê –í–ê–†–ò–ê–ù–¢ 2: –û–ü–¢–ò–ú–ê–õ–¨–ù–´–ô - –±—ã—Å—Ç—Ä–æ, –±–µ–∑–æ–ø–∞—Å–Ω–æ, user-friendly

set -e

echo "üéØ –û–ü–¢–ò–ú–ê–õ–¨–ù–û–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è..."
echo ""
echo "üîç –î–ò–ê–ì–ù–û–ó: –¢–∞–±–ª–∏—Ü–∞ user_tournament_stats –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢!"
echo "üí° –†–ï–®–ï–ù–ò–ï: –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É + —É–ª—É—á—à–∞–µ–º UX + –¥–æ–±–∞–≤–ª—è–µ–º error handling"
echo ""
echo "üìã –ß–¢–û –ë–£–î–ï–¢ –ò–°–ü–†–ê–í–õ–ï–ù–û:"
echo "   ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ user_tournament_stats –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç—É—Ä–Ω–∏—Ä–æ–≤"
echo "   ‚úÖ –£–ª—É—á—à–µ–Ω error handling —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã"
echo "   ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –¥–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
echo "   ‚úÖ UPSERT –≤–º–µ—Å—Ç–æ DELETE+INSERT –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
echo "   ‚úÖ Graceful degradation –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫"
echo "   ‚úÖ –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–∞ (success/error/loading)"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "package.json" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# 1. –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ GitHub
echo "üì• –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ GitHub..."
git pull origin main

# 2. –°–æ–∑–¥–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É user_tournament_stats
echo "üóÑÔ∏è –°–æ–∑–¥–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â—É—é —Ç–∞–±–ª–∏—Ü—É user_tournament_stats..."
if command -v psql &> /dev/null; then
    psql -U postgres -d 1337community -f backend/create_user_tournament_stats_table.sql
    echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ user_tournament_stats —Å–æ–∑–¥–∞–Ω–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∞"
else
    echo "‚ö†Ô∏è PostgreSQL –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –≤—Ä—É—á–Ω—É—é:"
    echo "   psql -U postgres -d 1337community -f backend/create_user_tournament_stats_table.sql"
fi

# 3. –û–±–Ω–æ–≤–ª—è–µ–º backend
echo "üîß –û–±–Ω–æ–≤–ª—è–µ–º backend..."
cd backend
npm install --production

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backend —Å–µ—Ä–≤–∏—Å
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backend —Å–µ—Ä–≤–∏—Å..."
sudo systemctl restart 1337-backend

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å backend
echo "üì° –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å backend —Å–µ—Ä–≤–∏—Å–∞..."
if sudo systemctl is-active --quiet 1337-backend; then
    echo "‚úÖ Backend —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ùå Backend —Å–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏..."
    sudo journalctl -u 1337-backend -n 10 --no-pager
    exit 1
fi

# 5. –û–±–Ω–æ–≤–ª—è–µ–º frontend
echo "üé® –û–±–Ω–æ–≤–ª—è–µ–º frontend..."
cd ../frontend
npm install --production
npm run build

# 6. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx
echo "üåê –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx..."
sudo systemctl reload nginx

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å nginx
echo "üì° –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å nginx..."
if sudo systemctl is-active --quiet nginx; then
    echo "‚úÖ Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ùå Nginx –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    sudo systemctl status nginx --no-pager -l
    exit 1
fi

# 7. –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–ª—é—á–µ–≤—ã–µ endpoints
echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º endpoints..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º endpoint –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ—à–∏–±–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
if curl -s -w "%{http_code}" "http://localhost:3000/api/users/recalculate-tournament-stats" -X POST | grep -q "401"; then
    echo "‚úÖ Endpoint –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Ç–≤–µ—á–∞–µ—Ç"
else
    echo "‚ö†Ô∏è Endpoint –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –¥–æ–ª–∂–Ω—ã–º –æ–±—Ä–∞–∑–æ–º"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ endpoints
if curl -s -f "http://localhost:3000/api/users/stats" > /dev/null 2>&1; then
    echo "‚úÖ Users stats endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ö†Ô∏è Users stats endpoint —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ)"
fi

# 8. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ backend..."
sudo journalctl -u 1337-backend -n 5 --no-pager | grep -E "(error|Error|ERROR)" || echo "‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"

# 9. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã user_tournament_stats..."
if command -v psql &> /dev/null; then
    if psql -U postgres -d 1337community -c "SELECT COUNT(*) FROM user_tournament_stats;" > /dev/null 2>&1; then
        echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ user_tournament_stats —Å–æ–∑–¥–∞–Ω–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–∞"
    else
        echo "‚ùå –¢–∞–±–ª–∏—Ü–∞ user_tournament_stats –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        exit 1
    fi
else
    echo "‚ö†Ô∏è –ù–µ –º–æ–≥—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É - PostgreSQL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

echo ""
echo "üéâ –û–ü–¢–ò–ú–ê–õ–¨–ù–´–ô –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!"
echo ""
echo "üìä –†–ï–ó–£–õ–¨–¢–ê–¢ –í–ù–ï–î–†–ï–ù–ò–Ø:"
echo "   üóÑÔ∏è –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ user_tournament_stats –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç—É—Ä–Ω–∏—Ä–æ–≤"
echo "   üîÑ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è"
echo "   üéØ –î–µ—Ç–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–∞: '–ü—Ä–æ–≤–µ—Ä—è–µ–º...', '–û–±–Ω–æ–≤–ª–µ–Ω–æ: X –∏–∑ Y', '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞'"
echo "   üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π UPSERT –≤–º–µ—Å—Ç–æ DELETE+INSERT –æ–ø–µ—Ä–∞—Ü–∏–π"
echo "   ‚ö° Graceful degradation - –µ—Å–ª–∏ –ø–µ—Ä–µ—Å—á–µ—Ç –Ω–µ —É–¥–∞–ª—Å—è, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—Å–µ —Ä–∞–≤–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è"
echo "   üé® –ö—Ä–∞—Å–∏–≤—ã–µ –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (–∑–∞–≥—Ä—É–∑–∫–∞/—É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞)"
echo ""
echo "üîó –ü–†–û–í–ï–†–ò–¢–¨ –†–ï–ó–£–õ–¨–¢–ê–¢:"
echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ https://1337community.com/profile"
echo "   2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'"
echo "   3. –£–≤–∏–¥–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ—Å—á–µ—Ç–∞: 'üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç—É—Ä–Ω–∏—Ä–æ–≤...'"
echo "   4. –ó–∞—Ç–µ–º: '‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: X –∏–∑ Y —Ç—É—Ä–Ω–∏—Ä–æ–≤' ‚Üí '‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞'"
echo "   5. –í –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–∞—Ö –ø–æ—è–≤—è—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–º–µ—Å—Ç–æ '–ù–µ —É–∫–∞–∑–∞–Ω'"
echo ""
echo "‚úÖ –°–∞–π—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å –ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–ß–ï–ô —Å–∏—Å—Ç–µ–º–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏!"
echo "üéØ –ü—Ä–æ–±–ª–µ–º–∞ '–ù–µ —É–∫–∞–∑–∞–Ω' –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö —Ç—É—Ä–Ω–∏—Ä–æ–≤ –†–ï–®–ï–ù–ê!"

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd .. 