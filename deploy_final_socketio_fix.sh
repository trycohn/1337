#!/bin/bash

# üö® –§–ò–ù–ê–õ–¨–ù–´–ô –°–ö–†–ò–ü–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø Socket.IO - Connection Refused
# 
# –í—ã—è–≤–ª–µ–Ω–∏–µ —Ç–æ—á–Ω–æ–π –ø—Ä–∏—á–∏–Ω—ã –ø–∞–¥–µ–Ω–∏—è Socket.IO —á–µ—Ä–µ–∑ –¥–µ—Ç–∞–ª—å–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
# –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –ª–æ–≥–∏ –ø–æ–∫–∞–∂—É—Ç —Ç–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ —Å–±–æ—è

echo "üö® –§–ò–ù–ê–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï Socket.IO - Connection Refused"
echo "========================================================="

echo ""
echo "üîç 1. –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –¢–ï–ö–£–©–ï–ì–û –°–û–°–¢–û–Ø–ù–ò–Ø:"
echo "-------------------------------------"

echo "üìä –°—Ç–∞—Ç—É—Å PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
pm2 status

echo ""
echo "üåê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP API:"
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://1337community.com/api/users/me || echo "ERROR")
echo "HTTP API —Å—Ç–∞—Ç—É—Å: $HTTP_STATUS"

echo ""
echo "üîå –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Socket.IO endpoint:"
SOCKETIO_TEST=$(curl -s https://1337community.com/test-socketio 2>/dev/null || echo '{"status":"error","message":"endpoint not found"}')
echo "Socket.IO —Ç–µ—Å—Ç: $SOCKETIO_TEST"

echo ""
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ backend:"
pm2 logs 1337-backend --lines 20 --nostream

echo ""
echo "üîß 2. –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –û–ë–ù–û–í–õ–ï–ù–ò–ô:"
echo "----------------------------"

echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å GitHub..."
if git pull origin main; then
    echo "‚úÖ Git pull —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ Git pull"
    exit 1
fi

echo ""
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ backend —Å –ø–æ–ª–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏..."
pm2 restart 1337-backend

echo ""
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏..."
sleep 5

echo ""
echo "üîç 3. –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–û–°–õ–ï –û–ë–ù–û–í–õ–ï–ù–ò–Ø:"
echo "-----------------------------------"

echo "üìã –õ–æ–≥–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å—Ç—Ä–æ–∫):"
pm2 logs 1337-backend --lines 30 --nostream

echo ""
echo "üß™ –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Socket.IO:"
SOCKETIO_TEST_AFTER=$(curl -s https://1337community.com/test-socketio 2>/dev/null || echo '{"status":"error","message":"endpoint still not available"}')
echo "Socket.IO —Ç–µ—Å—Ç –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: $SOCKETIO_TEST_AFTER"

echo ""
echo "üîå –ü–æ–ø—ã—Ç–∫–∞ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (—á–µ—Ä–µ–∑ curl):"
echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º Socket.IO endpoint..."
curl -I https://1337community.com/socket.io/ 2>/dev/null || echo "Socket.IO endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

echo ""
echo "üìä 4. –§–ò–ù–ê–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:"
echo "----------------------------"

echo "üîç –ü–æ–∏—Å–∫ Socket.IO –ª–æ–≥–æ–≤ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 50 —Å—Ç—Ä–æ–∫–∞—Ö:"
pm2 logs 1337-backend --lines 50 --nostream | grep -i "socket"

echo ""
echo "‚ùå –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö:"
pm2 logs 1337-backend --lines 50 --nostream | grep -i "error"

echo ""
echo "üéØ –û–ñ–ò–î–ê–ï–ú–´–ï –õ–û–ì–ò –ü–†–ò –£–°–ü–ï–®–ù–û–ô –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò:"
echo "---------------------------------------------"
echo "‚úÖ –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∏–¥–Ω—ã:"
echo "  üîå –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Socket.IO —Å–µ—Ä–≤–µ—Ä–∞..."
echo "  ‚úÖ Socket.IO —Å–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–Ω"
echo "  üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ middleware –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Socket.IO..."
echo "  ‚úÖ Middleware –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Socket.IO –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
echo "  üîå –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ —á–µ—Ä–µ–∑ Socket.IO..."
echo "  ‚úÖ –ß–∞—Ç Socket.IO –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
echo "  ‚úÖ Socket.IO —ç–∫–∑–µ–º–ø–ª—è—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ app"
echo "  ‚úÖ Socket.IO –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!"

echo ""
echo "üéØ –î–ï–ô–°–¢–í–ò–Ø –ï–°–õ–ò –õ–û–ì–ò –ù–ï –ü–û–Ø–í–ò–õ–ò–°–¨:"
echo "-----------------------------------"
echo "1. Socket.IO –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ - —Å–º–æ—Ç—Ä–µ—Ç—å error –ª–æ–≥–∏"
echo "2. –ü—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å package.json"
echo "3. –ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø–æ—Ä—Ç–æ–≤ - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å ss -tulpn | grep :3000"
echo "4. –ü—Ä–æ–±–ª–µ–º–∞ —Å chat-socketio.js - –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å setupChatSocketIO(io)"

echo ""
echo "üöÄ –ú–û–ù–ò–¢–û–†–ò–ù–ì –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò:"
echo "---------------------------------"
echo "–î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
echo "pm2 logs 1337-backend --follow"

echo ""
echo "‚úÖ –°–ö–†–ò–ü–¢ –ó–ê–í–ï–†–®–ï–ù! –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã." 