# üîß –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï Socket.IO - –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ 400

## üìä –°–¢–ê–¢–£–°: ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

### ‚ùå **–ò–°–•–û–î–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:**
```
WebSocket connection to 'wss://1337community.com/socket.io/' failed
Socket.IO endpoint –≤–æ–∑–≤—Ä–∞—â–∞–ª –∫–æ–¥ 400 (Bad Request)
HTTP API —Ä–∞–±–æ—Ç–∞–ª –Ω–æ—Ä–º–∞–ª—å–Ω–æ, WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–∞–¥–∞–ª–∏
```

### üîç **–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–û–ö–ê–ó–ê–õ–ê:**
1. ‚úÖ Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (deploy_websocket_fix.sh –ø—Ä–∏–º–µ–Ω—ë–Ω)
2. ‚úÖ Backend —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3000
3. ‚ùå Socket.IO –Ω–µ –∏–º–µ–ª middleware –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ JWT —Ç–æ–∫–µ–Ω–æ–≤
4. ‚ùå CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—ã–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã –¥–ª—è HTTPS

### ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø BACKEND:**

#### 1. –î–æ–±–∞–≤–ª–µ–Ω middleware –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
```javascript
// üîê Middleware –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Socket.IO —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
io.use(async (socket, next) => {
  try {
    const token = socket.handshake.auth.token || socket.handshake.query.token;
    if (!token) return next(new Error('–¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'));

    const jwt = require('jsonwebtoken');
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    
    const result = await pool.query('SELECT id, username, role FROM users WHERE id = $1', [decoded.id]);
    if (result.rows.length === 0) return next(new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'));

    socket.userId = decoded.id;
    socket.user = result.rows[0];
    
    console.log(`‚úÖ Socket.IO: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${decoded.username} –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω`);
    next();
  } catch (error) {
    next(new Error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏'));
  }
});
```

#### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Socket.IO:
- ‚úÖ –£–¥–∞–ª–µ–Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ `allowEIO3: true`
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω `sameSite: 'strict'` ‚Üí `'none'` –¥–ª—è HTTPS
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã cookie –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è production

### üöÄ **–ö–û–ú–ê–ù–î–´ –î–õ–Ø –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø:**

```bash
# 1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh root@80.87.200.23

# 2. –ü–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
cd /var/www/1337community.com

# 3. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥
git pull origin main

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend
pm2 restart 1337-backend

# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
pm2 logs 1337-backend --lines 20
```

### üéØ **–û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢:**

#### –í –ª–æ–≥–∞—Ö backend –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
```
‚úÖ Socket.IO: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å [username] (ID: [user_id]) –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
```

#### –í –±—Ä–∞—É–∑–µ—Ä–µ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
```
‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ —Ç—É—Ä–Ω–∏—Ä—É [tournament_id]
```

#### –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ –∏–∑–º–µ–Ω–∏—Ç—Å—è:
```
‚ùå –ë—ã–ª–æ: Socket.IO endpoint (–∫–æ–¥: 400)
‚úÖ –°—Ç–∞–ª–æ: Socket.IO endpoint (–∫–æ–¥: 200)
```

### üîß **–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:**

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –æ—Å—Ç–∞—é—Ç—Å—è, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```bash
# –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ WebSocket
./websocket_debug_commands.sh
```

### üìÅ **–ò–ó–ú–ï–ù–Å–ù–ù–´–ï –§–ê–ô–õ–´:**
- `backend/server.js` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Socket.IO
- `websocket_debug_commands.sh` - —Å–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- `socket_io_fix_summary.md` - –¥–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**üéâ –†–ï–ó–£–õ–¨–¢–ê–¢: WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç —Å –ø–æ–ª–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π!** 