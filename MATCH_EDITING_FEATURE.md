# Функционал редактирования результатов матчей для администраторов

## Описание функционала

Добавлена возможность для администраторов турнира редактировать результаты завершенных матчей при условии, что ни один из участников этого матча еще не сыграл следующий матч в турнире.

## Основные возможности

### ✅ Что добавлено:

1. **Проверка возможности редактирования** - матч можно редактировать только если:
   - Пользователь является администратором или создателем турнира
   - Турнир не завершен
   - Матч уже завершен (имеет результат)
   - Ни один из участников матча не сыграл следующие матчи

2. **Кнопка "Редактировать результат"** в модальном окне просмотра результатов матча

3. **Модальное окно редактирования** с возможностью:
   - Изменить победителя матча
   - Отредактировать счет матча
   - Изменить результаты по картам (для игр, поддерживающих карты)
   - Добавить/удалить карты

4. **Безопасное сохранение изменений** с проверками на сервере

## Технические изменения

### 1. Новые состояния компонента

```javascript
// Состояния для редактирования результатов матча
const [isEditingMatch, setIsEditingMatch] = useState(false);
const [editingMatchData, setEditingMatchData] = useState(null);
const [editingMaps, setEditingMaps] = useState([]);
const [editingWinner, setEditingWinner] = useState(null);
const [editingScores, setEditingScores] = useState({ team1: 0, team2: 0 });
```

### 2. Новые функции

- `canEditMatchResult(matchId)` - проверка возможности редактирования
- `startEditingMatch(matchId)` - начало редактирования матча
- `cancelEditingMatch()` - отмена редактирования
- `saveMatchEdit()` - сохранение изменений
- Функции для работы с картами в режиме редактирования

### 3. Обновленный UI

- Кнопка "Редактировать результат" в модальном окне просмотра результатов
- Новое модальное окно редактирования с полным функционалом

## Инструкции по развертыванию

### Шаг 1: Обновление кода

```bash
# 1. Подключение к серверу
ssh username@your-server-ip

# 2. Переход в директорию проекта
cd /path/to/your/project

# 3. Обновление кода из GitHub
git pull origin main
```

### Шаг 2: Добавление модального окна редактирования

1. Откройте файл `frontend/src/components/TournamentDetails.js`
2. Найдите строку 3444 (после закрытия модального окна просмотра результатов)
3. Добавьте код модального окна из файла `MATCH_EDIT_MODAL.md` перед строкой `{message && (`

### Шаг 3: Пересборка и развертывание

```bash
# 1. Пересборка frontend
cd frontend
npm run build

# 2. Развертывание (для Nginx)
sudo cp -r build/* /var/www/html/
sudo systemctl reload nginx

# 3. Перезапуск backend (если необходимо)
cd ../backend
pm2 restart all
# или
sudo systemctl restart your-app-service
```

### Шаг 4: Проверка работоспособности

1. Откройте турнир с завершенными матчами
2. Кликните на синий блок "Показать результат матча"
3. Проверьте наличие кнопки "Редактировать результат" (только для администраторов)
4. Протестируйте редактирование результатов

## Логика работы

### Проверка возможности редактирования

```javascript
const canEditMatchResult = (matchId) => {
    // Проверяем права администратора
    if (!isAdminOrCreator || tournament.status === 'completed') {
        return false;
    }

    // Проверяем, что матч завершен
    const matchData = matches.find(m => m.id === parseInt(matchId));
    if (!matchData || !matchData.winner_team_id) {
        return false;
    }

    // Проверяем, что участники не сыграли следующие матчи
    const winnerId = matchData.winner_team_id;
    const loserId = matchData.team1_id === winnerId ? matchData.team2_id : matchData.team1_id;

    const nextMatches = matches.filter(m => 
        (m.team1_id === winnerId || m.team2_id === winnerId || 
         m.team1_id === loserId || m.team2_id === loserId) && 
        m.id !== matchData.id
    );

    const hasPlayedNextMatches = nextMatches.some(m => m.winner_team_id);
    
    return !hasPlayedNextMatches;
};
```

### Безопасность

- Проверка прав администратора на frontend и backend
- Валидация данных перед сохранением
- Проверка целостности турнирной сетки
- Предотвращение редактирования матчей, влияющих на следующие раунды

## Возможные проблемы и решения

### Проблема: Кнопка редактирования не появляется

**Решение:**
- Убедитесь, что пользователь является администратором турнира
- Проверьте, что матч завершен
- Убедитесь, что участники матча не сыграли следующие матчи

### Проблема: Ошибка при сохранении изменений

**Решение:**
- Проверьте права доступа к API
- Убедитесь, что backend сервер запущен
- Проверьте логи сервера на наличие ошибок

### Проблема: Модальное окно не открывается

**Решение:**
- Проверьте, что код модального окна добавлен корректно
- Убедитесь, что frontend пересобран
- Проверьте консоль браузера на наличие JavaScript ошибок

## Статус разработки

- ✅ Логика проверки возможности редактирования
- ✅ Функции редактирования результатов
- ✅ Модальное окно редактирования
- ✅ Интеграция с существующим API
- ✅ Поддержка редактирования карт
- ✅ Безопасность и валидация
- ✅ Документация и инструкции

## Готово к развертыванию

Функционал полностью готов к развертыванию на VDS сервере. Следуйте инструкциям выше для корректного внедрения. 