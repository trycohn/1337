#!/bin/bash

# ========================================
# –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –û–ü–¶–ò–ò FULL DOUBLE ELIMINATION
# ========================================

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –æ–ø—Ü–∏–∏ Full Double Elimination..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "backend/server.js" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ 1337/"
    exit 1
fi

echo "üìç –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –®–ê–ì 1: –ú–ò–ì–†–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–•
# ========================================
echo ""
echo "üóÑÔ∏è –®–ê–ì 1: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

sudo -u postgres psql -d tournament_db -f add_full_double_elimination_option.sql

if [ $? -eq 0 ]; then
    echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏"
    exit 1
fi

# –®–ê–ì 2: –ü–†–û–í–ï–†–ö–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô –í GIT
# ========================================
echo ""
echo "üì¶ –®–ê–ì 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ —Å Git..."

git pull origin main

echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã:"
git log --oneline -5

# –®–ê–ì 3: –ü–ï–†–ï–ó–ê–ü–£–°–ö BACKEND
# ========================================
echo ""
echo "üîß –®–ê–ì 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ backend —Å–µ—Ä–≤–∏—Å–∞..."

sudo systemctl restart 1337-backend

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ —á—Ç–æ–±—ã —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
sleep 3

sudo systemctl status 1337-backend --no-pager -l

if [ $? -eq 0 ]; then
    echo "‚úÖ Backend —Å–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ backend —Å–µ—Ä–≤–∏—Å–∞"
    exit 1
fi

# –®–ê–ì 4: –°–ë–û–†–ö–ê –ò –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï FRONTEND
# ========================================
echo ""
echo "üé® –®–ê–ì 4: –°–±–æ—Ä–∫–∞ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ frontend..."

cd frontend

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ package.json
if [ ! -f "package.json" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: package.json –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ frontend"
    exit 1
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
npm install

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
npm run build

if [ $? -eq 0 ]; then
    echo "‚úÖ Frontend —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ frontend"
    exit 1
fi

# –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
sudo cp -r build/* /var/www/html/1337community/

echo "‚úÖ Frontend —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç —É—Å–ø–µ—à–Ω–æ"

cd ..

# –®–ê–ì 5: –ü–ï–†–ï–ó–ê–ü–£–°–ö NGINX
# ========================================
echo ""
echo "üåê –®–ê–ì 5: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx..."

sudo systemctl restart nginx

if [ $? -eq 0 ]; then
    echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ Nginx"
    exit 1
fi

# –®–ê–ì 6: –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –°–ï–†–í–ò–°–û–í
# ========================================
echo ""
echo "üîç –®–ê–ì 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."

echo "Backend —Å—Ç–∞—Ç—É—Å:"
sudo systemctl is-active 1337-backend

echo "Nginx —Å—Ç–∞—Ç—É—Å:"
sudo systemctl is-active nginx

# –®–ê–ì 7: –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
# ========================================
echo ""
echo "üß™ –®–ê–ì 7: –ë–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–∞–π—Ç –æ—Ç–≤–µ—á–∞–µ—Ç
if curl -s -o /dev/null -w "%{http_code}" http://localhost/ | grep -q "200"; then
    echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP 200)"
else
    echo "‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –°–∞–π—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º API
if curl -s -o /dev/null -w "%{http_code}" http://localhost/api/tournaments | grep -q "200"; then
    echo "‚úÖ API —Ç—É—Ä–Ω–∏—Ä–æ–≤ –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: API –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

# –ó–ê–í–ï–†–®–ï–ù–ò–ï
# ========================================
echo ""
echo "üéâ –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
echo ""
echo "üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:"
echo "  ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ full_double_elimination –≤ —Ç–∞–±–ª–∏—Ü—É tournaments"
echo "  ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –∫–æ–¥ backend —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Ω–æ–≤–æ–π –æ–ø—Ü–∏–∏"
echo "  ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω frontend —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ –¥–ª—è –æ–ø—Ü–∏–∏"
echo "  ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã"
echo ""
echo "üéØ –ß—Ç–æ –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:"
echo "  ‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞ —Å –æ–ø—Ü–∏–µ–π Full Double Elimination"
echo "  ‚Ä¢ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ—Ç–∫–∏ —Å –≤–∫–ª—é—á–µ–Ω–Ω–æ–π/–æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–π –æ–ø—Ü–∏–µ–π"
echo "  ‚Ä¢ –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ—Ç–∫–∏ —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –æ–ø—Ü–∏–∏"
echo ""
echo "üåê –û—Ç–∫—Ä–æ–π—Ç–µ: http://1337community.com/create-tournament"
echo "üìù –í—ã–±–µ—Ä–∏—Ç–µ Double Elimination –∏ –Ω–∞–π–¥–∏—Ç–µ —á–µ–∫–±–æ–∫—Å 'üèÜ –í–∫–ª—é—á–∏—Ç—å Full Double Elimination?'"

echo ""
echo "‚ú® –ì–æ—Ç–æ–≤–æ! Grand Final Triumph —Ç–µ–ø–µ—Ä—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π! ‚ú®"