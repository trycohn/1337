#!/bin/bash

# üîß –£–õ–¨–¢–ò–ú–ê–¢–ò–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï WEBSOCKET + HTTP/2 v2.0
# –ü–æ–ª–Ω–æ–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ HTTP/2 –∏–∑ –≤—Å–µ—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π + –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
# –ê–≤—Ç–æ—Ä: Senior Fullstack Developer

set -e

echo "üîß === –£–õ–¨–¢–ò–ú–ê–¢–ò–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï HTTP/2 + WEBSOCKET v2.0 ==="
echo "üìÖ –î–∞—Ç–∞: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

echo "üö® –ü–†–û–ë–õ–ï–ú–ê: HTTP/2 –±–ª–æ–∫–∏—Ä—É–µ—Ç WebSocket upgrade (RFC –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ)"
echo "üí° –†–ï–®–ï–ù–ò–ï: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ HTTP/2 + —Å–æ–∑–¥–∞–Ω–∏–µ HTTP/1.1 only –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
if [[ ! -d "/var/www/1337community.com" ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –Ω–∞ VDS —Å–µ—Ä–≤–µ—Ä–µ 1337community.com"
    exit 1
fi

echo "üîß 1. –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –¢–ï–ö–£–©–ï–ì–û –°–û–°–¢–û–Ø–ù–ò–Ø"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é HTTP/2:"
HTTP2_COUNT=$(nginx -T 2>/dev/null | grep -c "http2" || echo "0")
echo "üìä –ù–∞–π–¥–µ–Ω–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π HTTP/2: $HTTP2_COUNT"

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ—Ä—Ç—ã Nginx:"
ss -tlnp | grep nginx || echo "Nginx –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–æ—Ä—Ç–∞—Ö"

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å Backend:"
pm2 list | grep 1337-backend || echo "Backend –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ PM2"

echo ""
echo "üîß 2. –ü–û–õ–ù–û–ï –£–î–ê–õ–ï–ù–ò–ï HTTP/2 –ò–ó NGINX.CONF"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# –°–æ–∑–¥–∞–µ–º backup —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –∏–º–µ–Ω–µ–º
BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup.ultimate.$BACKUP_DATE
echo "‚úÖ Backup —Å–æ–∑–¥–∞–Ω: nginx.conf.backup.ultimate.$BACKUP_DATE"

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª—è–µ–º –í–°–ï —É–ø–æ–º–∏–Ω–∞–Ω–∏—è HTTP/2
sed -i '/http2/d' /etc/nginx/nginx.conf
sed -i '/HTTP\/2/d' /etc/nginx/nginx.conf
echo "‚úÖ –£–¥–∞–ª–µ–Ω—ã –≤—Å–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è HTTP/2 –∏–∑ nginx.conf"

echo ""
echo "üîß 3. –°–û–ó–î–ê–ù–ò–ï –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–û–ô –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò –°–ê–ô–¢–ê"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# Backup –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∞–π—Ç–∞
cp /etc/nginx/sites-available/1337community.com /etc/nginx/sites-available/1337community.com.backup.ultimate.$BACKUP_DATE
echo "‚úÖ Backup –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∞–π—Ç–∞ —Å–æ–∑–¥–∞–Ω"

# –°–æ–∑–¥–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è WebSocket
cat > /etc/nginx/sites-available/1337community.com << 'EOF'
# üîß –£–õ–¨–¢–ò–ú–ê–¢–ò–í–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø v2.0: HTTP/1.1 ONLY
# –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π WebSocket –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

# Map –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ –¥–ª—è WebSocket (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û)
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    server_name 1337community.com www.1337community.com;
    
    # Security headers –¥–∞–∂–µ –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    
    return 301 https://1337community.com$request_uri;
}

# Main HTTPS server - HTTP/1.1 ONLY –¥–ª—è WebSocket —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
server {
    # üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –¢–û–õ–¨–ö–û HTTP/1.1, –ù–ò–ö–ê–ö–û–ì–û HTTP/2!
    listen 443 ssl;
    server_name 1337community.com www.1337community.com;

    # üîí SSL Configuration
    ssl_certificate /etc/letsencrypt/live/1337community.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/1337community.com/privkey.pem;
    
    # Modern SSL settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Security headers
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # üîå SOCKET.IO - –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø WEBSOCKET –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨
    location /socket.io/ {
        proxy_pass http://127.0.0.1:3000;
        
        # üî• –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û HTTP/1.1 –¥–ª—è WebSocket
        proxy_http_version 1.1;
        
        # üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï WebSocket –∑–∞–≥–æ–ª–æ–≤–∫–∏
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # üöÄ WebSocket –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400;  # 24 —á–∞—Å–∞ –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
        proxy_send_timeout 86400;
        proxy_connect_timeout 60s;
        
        # üåê CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è WebSocket
        add_header 'Access-Control-Allow-Origin' 'https://1337community.com' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
    }

    # üì° Test endpoint –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ Socket.IO
    location /test-socketio {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # üîå Backend API
    location /api/ {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # API –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # üìÅ Frontend (React SPA)
    location / {
        root /var/www/1337community.com/frontend/build;
        try_files $uri $uri/ /index.html;
        index index.html;
        
        # –°–∂–∞—Ç–∏–µ –¥–ª—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è HTTP/2
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_comp_level 6;
        gzip_types
            text/plain
            text/css
            text/xml
            text/javascript
            application/javascript
            application/xml+rss
            application/json;
        
        # üèÉ‚Äç‚ôÇÔ∏è –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏–∫–∏
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            gzip_static on;
        }
        
        # HTML —Ñ–∞–π–ª—ã –±–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
        location ~* \.(html)$ {
            expires -1;
            add_header Cache-Control "no-store, no-cache, must-revalidate";
        }
    }

    # üìÅ Static uploads
    location /uploads/ {
        root /var/www/1337community.com/backend;
        expires 1y;
        add_header Cache-Control "public";
        
        # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–æ–∫
        location ~* \.(php|pl|py|jsp|asp|sh|cgi)$ {
            deny all;
        }
    }
}
EOF

echo "‚úÖ –°–æ–∑–¥–∞–Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è HTTP/1.1"

echo ""
echo "üîß 4. –û–ë–ù–û–í–õ–ï–ù–ò–ï NGINX.CONF –î–õ–Ø WEBSOCKET"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ map –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ –µ—Å—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
if ! grep -q "map.*http_upgrade.*connection_upgrade" /etc/nginx/nginx.conf; then
    echo "üìù –î–æ–±–∞–≤–ª—è–µ–º map –¥–∏—Ä–µ–∫—Ç–∏–≤—É –≤ nginx.conf..."
    
    # –ò—â–µ–º —Å–µ–∫—Ü–∏—é http –∏ –¥–æ–±–∞–≤–ª—è–µ–º map –¥–∏—Ä–µ–∫—Ç–∏–≤—É
    sed -i '/^http {/a\
\
    # WebSocket support\
    map $http_upgrade $connection_upgrade {\
        default upgrade;\
        "" close;\
    }' /etc/nginx/nginx.conf
    
    echo "‚úÖ Map –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ nginx.conf"
else
    echo "‚úÖ Map –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ nginx.conf"
fi

echo ""
echo "üîß 5. TRIPLE –ü–†–û–í–ï–†–ö–ê HTTP/2"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

echo "üîç –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - nginx.conf:"
HTTP2_MAIN=$(grep -c "http2" /etc/nginx/nginx.conf 2>/dev/null || echo "0")
if [ "$HTTP2_MAIN" -gt 0 ]; then
    echo "‚ùå HTTP/2 –Ω–∞–π–¥–µ–Ω –≤ nginx.conf, —É–¥–∞–ª—è–µ–º –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û..."
    sed -i '/http2/d' /etc/nginx/nginx.conf
    sed -i '/HTTP\/2/d' /etc/nginx/nginx.conf
    echo "‚úÖ HTTP/2 –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ nginx.conf"
else
    echo "‚úÖ HTTP/2 –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ nginx.conf"
fi

echo "üîç –í—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∞–π—Ç–∞:"
HTTP2_SITE=$(grep -c "http2" /etc/nginx/sites-available/1337community.com 2>/dev/null || echo "0")
if [ "$HTTP2_SITE" -gt 0 ]; then
    echo "‚ùå HTTP/2 –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∞–π—Ç–∞, —É–¥–∞–ª—è–µ–º..."
    sed -i '/http2/d' /etc/nginx/sites-available/1337community.com
    sed -i '/HTTP\/2/d' /etc/nginx/sites-available/1337community.com
    echo "‚úÖ HTTP/2 —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∞–π—Ç–∞"
else
    echo "‚úÖ HTTP/2 –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∞–π—Ç–∞"
fi

echo "üîç –¢—Ä–µ—Ç—å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –ø–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:"
HTTP2_TOTAL=$(nginx -T 2>/dev/null | grep -c "http2" || echo "0")
echo "üìä –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π HTTP/2: $HTTP2_TOTAL"

if [ "$HTTP2_TOTAL" -eq 0 ]; then
    echo "üéâ HTTP/2 –ü–û–õ–ù–û–°–¢–¨–Æ –û–¢–°–£–¢–°–¢–í–£–ï–¢ –í –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò!"
else
    echo "‚ö†Ô∏è HTTP/2 –≤—Å–µ –µ—â–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ($HTTP2_TOTAL —É–ø–æ–º–∏–Ω–∞–Ω–∏–π)"
fi

echo ""
echo "üîß 6. –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
if nginx -t; then
    echo "‚úÖ Nginx: —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
else
    echo "‚ùå Nginx: –æ—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏!"
    echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º backup..."
    cp /etc/nginx/nginx.conf.backup.ultimate.$BACKUP_DATE /etc/nginx/nginx.conf
    cp /etc/nginx/sites-available/1337community.com.backup.ultimate.$BACKUP_DATE /etc/nginx/sites-available/1337community.com
    nginx -t
    exit 1
fi

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx
echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx..."
systemctl reload nginx
sleep 2

if systemctl is-active --quiet nginx; then
    echo "‚úÖ Nginx —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω –∏ –∞–∫—Ç–∏–≤–µ–Ω"
else
    echo "‚ùå Nginx –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è!"
    systemctl status nginx
    exit 1
fi

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backend
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backend..."
pm2 restart 1337-backend
sleep 5

if pm2 list | grep -q "1337-backend.*online"; then
    echo "‚úÖ Backend —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
else
    echo "‚ùå Backend –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è!"
    pm2 status
    exit 1
fi

echo ""
echo "üß™ 7. –ö–û–ú–ü–õ–ï–ö–°–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

echo "üîç 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ HTTP/2 –≤ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:"
FINAL_HTTP2_CHECK=$(nginx -T 2>/dev/null | grep -c "http2" || echo "0")
if [ "$FINAL_HTTP2_CHECK" -eq 0 ]; then
    echo "‚úÖ HTTP/2 –ü–û–õ–ù–û–°–¢–¨–Æ –û–¢–°–£–¢–°–¢–í–£–ï–¢ –í –ê–ö–¢–ò–í–ù–û–ô –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò!"
else
    echo "‚ùå HTTP/2 –Ω–∞–π–¥–µ–Ω –≤ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ($FINAL_HTTP2_CHECK —É–ø–æ–º–∏–Ω–∞–Ω–∏–π)"
    nginx -T 2>/dev/null | grep -n "http2"
fi

echo ""
echo "üîç 2. –¢–µ—Å—Ç–∏—Ä—É–µ–º Socket.IO polling transport:"
POLLING_TEST=$(curl -s --max-time 10 'https://1337community.com/socket.io/?EIO=4&transport=polling' 2>/dev/null || echo "FAILED")
if [[ "$POLLING_TEST" == *"sid"* ]]; then
    echo "‚úÖ Socket.IO polling —Ä–∞–±–æ—Ç–∞–µ—Ç!"
    echo "üìÑ Response preview: $(echo "$POLLING_TEST" | head -c 100)..."
else
    echo "‚ùå Socket.IO polling –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç"
    echo "üìÑ Response: $POLLING_TEST"
fi

echo ""
echo "üîç 3. –¢–µ—Å—Ç–∏—Ä—É–µ–º backend test endpoint:"
TEST_ENDPOINT=$(curl -s --max-time 10 https://1337community.com/test-socketio 2>/dev/null || echo "FAILED")
if [[ "$TEST_ENDPOINT" == *"success"* ]]; then
    echo "‚úÖ Backend test endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç!"
    echo "üìÑ Response: $TEST_ENDPOINT"
else
    echo "‚ùå Backend test endpoint –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç"
    echo "üìÑ Response: $TEST_ENDPOINT"
fi

echo ""
echo "üîç 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º WebSocket headers (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 400, –Ω–µ 404):"
WS_HEADERS=$(curl -I -s --max-time 5 \
    -H "Connection: Upgrade" \
    -H "Upgrade: websocket" \
    -H "Sec-WebSocket-Version: 13" \
    -H "Sec-WebSocket-Key: test123" \
    https://1337community.com/socket.io/ 2>/dev/null | head -1)
echo "üìÑ WebSocket response: $WS_HEADERS"

if [[ "$WS_HEADERS" == *"400"* ]]; then
    echo "‚úÖ WebSocket endpoint –¥–æ—Å—Ç—É–ø–µ–Ω (400 –æ–∂–∏–¥–∞–µ–º–æ –±–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ handshake)"
elif [[ "$WS_HEADERS" == *"404"* ]]; then
    echo "‚ùå WebSocket endpoint –Ω–µ –Ω–∞–π–¥–µ–Ω (404)"
else
    echo "‚ÑπÔ∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç WebSocket endpoint"
fi

echo ""
echo "üîç 5. –°–∏—Å—Ç–µ–º–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:"
echo "üìä Nginx –ø—Ä–æ—Ü–µ—Å—Å—ã: $(ps aux | grep -c '[n]ginx' || echo "0")"
echo "üìä Nginx –ø–æ—Ä—Ç—ã: $(ss -tlnp | grep nginx | wc -l)"
echo "üìä PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã: $(pm2 list | grep -c online || echo "0")"

echo ""
echo "üéâ –£–õ–¨–¢–ò–ú–ê–¢–ò–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï v2.0 –ó–ê–í–ï–†–®–ï–ù–û!"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""
echo "üìã –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:"
echo "‚úÖ HTTP/2: –ü–û–õ–ù–û–°–¢–¨–Æ —É–¥–∞–ª–µ–Ω –∏–∑ –≤—Å–µ—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π"
echo "‚úÖ HTTP/1.1: –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –í–°–ï–ì–û —Ç—Ä–∞—Ñ–∏–∫–∞"
echo "‚úÖ WebSocket: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞"
echo "‚úÖ Map –¥–∏—Ä–µ–∫—Ç–∏–≤–∞: –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –¥–ª—è upgrade —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π"
echo "‚úÖ Gzip —Å–∂–∞—Ç–∏–µ: –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ HTTP/2"
echo "‚úÖ Security headers: –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
echo "‚úÖ –¢–∞–π–º–∞—É—Ç—ã: –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π"
echo ""
echo "üîó –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –í –ë–†–ê–£–ó–ï–†–ï:"
echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ https://1337community.com"
echo "2. –û—á–∏—Å—Ç–∏—Ç–µ –≤–µ—Å—å –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞ (Ctrl+Shift+Del ‚Üí –í—Å–µ –≤—Ä–µ–º—è)"
echo "3. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí Console"
echo "4. WebSocket –æ—à–∏–±–∫–∏ –¥–æ–ª–∂–Ω—ã –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ß–ï–ó–ù–£–¢–¨!"
echo "5. –ò—â–∏—Ç–µ –ª–æ–≥–∏ '[Socket.IO Final] –ü–û–î–ö–õ–Æ–ß–ï–ù–û!'"
echo ""
echo "üö® –ï–°–õ–ò –û–®–ò–ë–ö–ò –í–°–ï –ï–©–ï –ï–°–¢–¨:"
echo "- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é"
echo "- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ"
echo "- –û—Ç–∫–ª—é—á–∏—Ç–µ –≤—Å–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞"
echo "- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä"
echo ""
echo "üìû –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:"
echo "- –õ–æ–≥–∏ Nginx: tail -f /var/log/nginx/error.log"
echo "- –õ–æ–≥–∏ Backend: pm2 logs 1337-backend"
echo "- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: nginx -T | grep -A 10 -B 10 socket.io"
echo "" 

