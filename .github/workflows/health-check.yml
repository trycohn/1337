name: Health Check VDS
on:
  schedule:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
    - name: Check VDS Health
      uses: appleboy/ssh-action@v0.1.9
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          echo "üè• –ü–†–û–í–ï–†–ö–ê –ó–î–û–†–û–í–¨–Ø –°–ò–°–¢–ï–ú–´"
          echo "–í—Ä–µ–º—è: $(date)"
          echo "================================"
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ PM2 –ø—Ä–æ—Ü–µ—Å—Å–∞
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ PM2 –ø—Ä–æ—Ü–µ—Å—Å–∞..."
          PM2_STATUS=$(pm2 jlist | jq -r '.[0].pm2_env.status' 2>/dev/null || echo "error")
          
          if [ "$PM2_STATUS" = "online" ]; then
            echo "‚úÖ Backend –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç–∞–µ—Ç"
          else
            echo "‚ùå Backend –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç! –°—Ç–∞—Ç—É—Å: $PM2_STATUS"
            echo "üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞..."
            cd /var/www/1337community.com/backend
            pm2 start server.js --name "1337-backend" || pm2 restart 1337-backend
          fi
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ Nginx
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Nginx..."
          if systemctl is-active --quiet nginx; then
            echo "‚úÖ Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç"
          else
            echo "‚ùå Nginx –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
            echo "üîÑ –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ Nginx..."
            sudo systemctl start nginx
          fi
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ API..."
          HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:3001/api/tournaments || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $HTTP_STATUS)"
          else
            echo "‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $HTTP_STATUS)"
          fi
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤..."
          
          # –ü–∞–º—è—Ç—å
          MEMORY_USAGE=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
          echo "üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: $MEMORY_USAGE%"
          
          if (( $(echo "$MEMORY_USAGE > 90" | bc -l) )); then
            echo "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏!"
          fi
          
          # –î–∏—Å–∫
          DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
          echo "üíø –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞: $DISK_USAGE%"
          
          if [ "$DISK_USAGE" -gt 85 ]; then
            echo "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ú–∞–ª–æ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ!"
          fi
          
          # CPU Load
          LOAD_AVG=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | sed 's/,//')
          echo "‚ö° –°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞: $LOAD_AVG"
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ –æ—à–∏–±–∫–∏
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ—à–∏–±–æ–∫..."
          ERROR_COUNT=$(pm2 logs 1337-backend --lines 100 --nostream 2>/dev/null | grep -i "error\|exception\|failed" | wc -l)
          
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ $ERROR_COUNT –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫"
            echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏:"
            pm2 logs 1337-backend --lines 100 --nostream | grep -i "error\|exception\|failed" | tail -5
          else
            echo "‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
          fi
          
          echo "================================"
          echo "üèÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
          
    - name: Create Issue on Failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'üö® VDS Health Check Failed',
            body: `
            ## üö® –ü—Ä–æ–±–ª–µ–º–∞ —Å VDS —Å–µ—Ä–≤–µ—Ä–æ–º
            
            **–í—Ä–µ–º—è:** ${new Date().toISOString()}
            **Workflow:** ${context.workflow}
            **Run ID:** ${context.runId}
            
            –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã –≤—ã—è–≤–∏–ª–∞ –ø—Ä–æ–±–ª–µ–º—ã.
            
            ### –î–µ–π—Å—Ç–≤–∏—è:
            1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ workflow
            2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É: \`ssh root@80.87.200.23\`
            3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤: \`pm2 status && systemctl status nginx\`
            4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä—É—á–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
            
            ### –ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:
            \`\`\`bash
            pm2 logs 1337-backend --lines 20
            systemctl status nginx
            df -h
            free -h
            \`\`\`
            `,
            labels: ['bug', 'urgent', 'vds']
          })