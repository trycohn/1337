name: Manual Deploy & Rollback
on:
  workflow_dispatch:
    inputs:
      action:
        description: '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ'
        required: true
        default: 'deploy'
        type: choice
        options:
        - deploy
        - rollback
        - status
        - restart-backend
        - restart-nginx
      commit_hash:
        description: '–•–µ—à –∫–æ–º–º–∏—Ç–∞ –¥–ª—è –æ—Ç–∫–∞—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è rollback)'
        required: false
        type: string

jobs:
  manual-action:
    runs-on: ubuntu-latest
    steps:
    - name: Execute Action on VDS
      uses: appleboy/ssh-action@v0.1.9
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd /var/www/1337community.com
          
          case "${{ github.event.inputs.action }}" in
            "deploy")
              echo "üöÄ –†–£–ß–ù–û–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï"
              echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞..."
              git pull
              
              echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ backend..."
              pm2 stop 1337-backend || true
              pm2 delete 1337-backend || true
              
              echo "üìã –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
              npm install
              
              echo "üîß Backend setup..."
              cd backend && npm install
              pm2 start server.js --name "1337-backend"
              
              echo "üé® Frontend setup..."
              cd ../frontend
              npm install --legacy-peer-deps
              npm run build
              
              echo "üîÑ Nginx reload..."
              sudo nginx -s reload
              
              echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
              pm2 status
              ;;
              
            "rollback")
              echo "‚è™ –û–¢–ö–ê–¢ –ö –ü–†–ï–î–´–î–£–©–ï–ô –í–ï–†–°–ò–ò"
              COMMIT_HASH="${{ github.event.inputs.commit_hash }}"
              
              if [ -n "$COMMIT_HASH" ]; then
                echo "üì¶ –û—Ç–∫–∞—Ç –∫ –∫–æ–º–º–∏—Ç—É: $COMMIT_HASH"
                git reset --hard $COMMIT_HASH
              else
                echo "üì¶ –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–æ–º–º–∏—Ç—É"
                git reset --hard HEAD~1
              fi
              
              echo "üîß –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ø–æ—Å–ª–µ –æ—Ç–∫–∞—Ç–∞..."
              pm2 stop 1337-backend || true
              pm2 delete 1337-backend || true
              npm install
              cd backend && npm install
              pm2 start server.js --name "1337-backend"
              cd ../frontend
              npm install --legacy-peer-deps
              npm run build
              sudo nginx -s reload
              
              echo "‚úÖ –û—Ç–∫–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!"
              ;;
              
            "status")
              echo "üìä –°–¢–ê–¢–£–° –°–ï–†–í–ò–°–û–í"
              echo "=== PM2 STATUS ==="
              pm2 status
              echo ""
              echo "=== NGINX STATUS ==="
              sudo systemctl status nginx --no-pager -l
              echo ""
              echo "=== DISK USAGE ==="
              df -h
              echo ""
              echo "=== MEMORY USAGE ==="
              free -h
              echo ""
              echo "=== LAST 10 BACKEND LOGS ==="
              pm2 logs 1337-backend --lines 10 --nostream
              ;;
              
            "restart-backend")
              echo "üîÑ –ü–ï–†–ï–ó–ê–ü–£–°–ö BACKEND"
              pm2 restart 1337-backend
              echo "‚úÖ Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
              pm2 status
              ;;
              
            "restart-nginx")
              echo "üîÑ –ü–ï–†–ï–ó–ê–ü–£–°–ö NGINX"
              sudo nginx -s reload
              echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
              sudo systemctl status nginx --no-pager -l
              ;;
              
            *)
              echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: ${{ github.event.inputs.action }}"
              exit 1
              ;;
          esac