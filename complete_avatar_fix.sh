#!/bin/bash

# –ü–æ–ª–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 1337community
# –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

echo "üîß –ü–û–õ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ê–í–ê–¢–ê–†–ê –°–ò–°–¢–ï–ú–ù–û–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø 1337community"
echo "=================================================================="

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /var/www/1337community || {
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ /var/www/1337community"
    exit 1
}

echo "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ GitHub
echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitHub..."
git pull origin main
if [ $? -ne 0 ]; then
    echo "‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –∏–∑ GitHub"
fi

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é backend
cd backend || {
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é backend"
    exit 1
}

# –ó–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
echo ""
echo "üîç –≠–¢–ê–ü 1: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è"
echo "=========================================="
NODE_ENV=production node debug_system_avatar.js
if [ $? -ne 0 ]; then
    echo "‚ö†Ô∏è –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–∞–º–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ..."
fi

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
echo ""
echo "üîÑ –≠–¢–ê–ü 2: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞"
echo "============================================"
NODE_ENV=production node force_update_system_avatar.js
if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–∞"
    exit 1
fi

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd ..

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
echo ""
echo "üîÑ –≠–¢–ê–ü 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞"
echo "============================"
sudo systemctl restart 1337-backend
if [ $? -eq 0 ]; then
    echo "‚úÖ –°–µ—Ä–≤–∏—Å 1337-backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å 1337-backend —á–µ—Ä–µ–∑ systemctl"
    echo "üîÑ –ü—ã—Ç–∞–µ–º—Å—è —á–µ—Ä–µ–∑ PM2..."
    pm2 restart 1337-backend 2>/dev/null || {
        echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ PM2"
        echo "üìã –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å –≤—Ä—É—á–Ω—É—é"
    }
fi

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
echo ""
echo "üìã –≠–¢–ê–ü 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞"
echo "==================================="
if systemctl is-active --quiet 1337-backend; then
    echo "‚úÖ –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ systemctl"
    sudo systemctl status 1337-backend --no-pager -l | head -20
elif pm2 list | grep -q "1337-backend.*online"; then
    echo "‚úÖ –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ PM2"
    pm2 list | grep 1337-backend
else
    echo "‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∞
echo ""
echo "üìÅ –≠–¢–ê–ü 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ –∞–≤–∞—Ç–∞—Ä–∞"
echo "================================="
if [ -f "backend/uploads/avatars/1337-logo-chat.png" ]; then
    echo "‚úÖ –§–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∞ –Ω–∞–π–¥–µ–Ω: backend/uploads/avatars/1337-logo-chat.png"
    ls -la backend/uploads/avatars/1337-logo-chat.png
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
    FILE_SIZE=$(stat -c%s "backend/uploads/avatars/1337-logo-chat.png" 2>/dev/null || echo "0")
    if [ "$FILE_SIZE" -gt 1000 ]; then
        echo "‚úÖ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π: $FILE_SIZE –±–∞–π—Ç"
    else
        echo "‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π: $FILE_SIZE –±–∞–π—Ç"
    fi
else
    echo "‚ùå –§–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∞ –ù–ï –ù–ê–ô–î–ï–ù: backend/uploads/avatars/1337-logo-chat.png"
    echo "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ backend/uploads/avatars/:"
    ls -la backend/uploads/avatars/ 2>/dev/null || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ HTTP
echo ""
echo "üåê –≠–¢–ê–ü 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTP –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏"
echo "===================================="
if command -v curl >/dev/null 2>&1; then
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
    LOCAL_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/uploads/avatars/1337-logo-chat.png)
    if [ "$LOCAL_STATUS" = "200" ]; then
        echo "‚úÖ –ê–≤–∞—Ç–∞—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ (—Å—Ç–∞—Ç—É—Å: $LOCAL_STATUS)"
    else
        echo "‚ùå –ê–≤–∞—Ç–∞—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ (—Å—Ç–∞—Ç—É—Å: $LOCAL_STATUS)"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ –¥–æ–º–µ–Ω (–µ—Å–ª–∏ production)
    if [ "$NODE_ENV" = "production" ]; then
        PROD_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://1337community.com/uploads/avatars/1337-logo-chat.png)
        if [ "$PROD_STATUS" = "200" ]; then
            echo "‚úÖ –ê–≤–∞—Ç–∞—Ä –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ –¥–æ–º–µ–Ω (—Å—Ç–∞—Ç—É—Å: $PROD_STATUS)"
        else
            echo "‚ùå –ê–≤–∞—Ç–∞—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ –¥–æ–º–µ–Ω (—Å—Ç–∞—Ç—É—Å: $PROD_STATUS)"
        fi
    fi
else
    echo "‚ö†Ô∏è curl –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º HTTP –ø—Ä–æ–≤–µ—Ä–∫—É"
fi

# –§–∏–Ω–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
echo ""
echo "üîç –≠–¢–ê–ü 7: –§–∏–Ω–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞"
echo "================================"
cd backend
NODE_ENV=production node debug_system_avatar.js
FINAL_RESULT=$?
cd ..

echo ""
echo "üéâ –ü–û–õ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
echo "==============================="
echo ""
echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:"
if [ $FINAL_RESULT -eq 0 ]; then
    echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
    echo "‚úÖ –ê–≤–∞—Ç–∞—Ä —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–µ–Ω –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
else
    echo "‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ"
fi

echo ""
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. ‚úÖ –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞ (Ctrl+F5)"
echo "2. ‚úÖ –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ"
echo "3. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á–∞—Ç —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º '1337community'"
echo "4. ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∞–≤–∞—Ç–∞—Ä –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ –ª–æ–≥–æ—Ç–∏–ø 1337"

echo ""
echo "üîç –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞:"
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞: sudo journalctl -u 1337-backend -f"
echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ PM2: pm2 logs 1337-backend"
echo "3. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏"

echo ""
echo "üèÅ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–µ–Ω: $(date)"
echo "–°—Ç–∞—Ç—É—Å: $([ $FINAL_RESULT -eq 0 ] && echo "‚úÖ –£–°–ü–ï–®–ù–û" || echo "‚ö†Ô∏è –° –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø–ú–ò")" 