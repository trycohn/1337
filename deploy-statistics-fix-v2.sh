#!/bin/bash

# üöÄ –§–ò–ù–ê–õ–¨–ù–´–ô —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç—É—Ä–Ω–∏—Ä–æ–≤ v2.0
# ‚≠ê –°–†–ï–î–ù–ò–ô –†–ï–§–ê–ö–¢–û–†–ò–ù–ì: –ø–æ–ª–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã "–ù–µ —É–∫–∞–∑–∞–Ω" –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
# üéØ Senior fullstack developer solution

set -e

echo "üöÄ –§–ò–ù–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï –ø—Ä–æ–±–ª–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç—É—Ä–Ω–∏—Ä–æ–≤ v2.0"
echo ""
echo "üîç –ù–ê–ô–î–ï–ù–ù–´–ï –ò –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:"
echo "   ‚ùå Endpoint /end –ù–ï –≤—ã–∑—ã–≤–∞–ª –ø–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ‚Üí ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ"
echo "   ‚ùå DELETE+INSERT –≤–º–µ—Å—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ UPSERT ‚Üí ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ"
echo "   ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ calculateTournamentResult ‚Üí ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ"
echo "   ‚ùå –ü–ª–æ—Ö–æ–π error handling –∏ UX ‚Üí ‚úÖ –£–ª—É—á—à–µ–Ω–æ"
echo "   ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–∂–æ–π–Ω –≤ /api/users/tournaments ‚Üí ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ"
echo ""
echo "üéØ –ß–¢–û –ë–£–î–ï–¢ –£–õ–£–ß–®–ï–ù–û:"
echo "   ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ç—É—Ä–Ω–∏—Ä–∞ (/end + /complete)"
echo "   ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π UPSERT –≤–º–µ—Å—Ç–æ DELETE+INSERT –≤ 2 –º–µ—Å—Ç–∞—Ö"
echo "   ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –ø–µ—Ä–µ—Å—á–µ—Ç–∞: '–û–±–Ω–æ–≤–ª–µ–Ω–æ: X –∏–∑ Y —Ç—É—Ä–Ω–∏—Ä–æ–≤'"
echo "   ‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–π error handling —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏"
echo "   ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π JOIN —Ç–∞–±–ª–∏—Ü—ã user_tournament_stats"
echo "   ‚úÖ Real-time –ø–æ–∫–∞–∑ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"
echo "   ‚úÖ Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "package.json" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# 1. –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ GitHub
echo "üì• –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ GitHub..."
git pull origin main

# 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º/—Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É user_tournament_stats
echo "üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É user_tournament_stats..."
if command -v psql &> /dev/null; then
    echo "üìä –í—ã–ø–æ–ª–Ω—è–µ–º SQL —Å–∫—Ä–∏–ø—Ç..."
    SQL_OUTPUT=$(psql -U postgres -d 1337community -f backend/create_user_tournament_stats_table.sql 2>&1)
    SQL_EXIT_CODE=$?
    
    echo "$SQL_OUTPUT"
    
    if [ $SQL_EXIT_CODE -eq 0 ]; then
        if echo "$SQL_OUTPUT" | grep -q "üéâ –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û"; then
            echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ user_tournament_stats –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ"
        else
            echo "‚ÑπÔ∏è –¢–∞–±–ª–∏—Ü–∞ user_tournament_stats –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"
        fi
    else
        echo "‚ùå –û—à–∏–±–∫–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π user_tournament_stats"
        exit 1
    fi
else
    echo "‚ö†Ô∏è PostgreSQL –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –≤—Ä—É—á–Ω—É—é"
fi

# 3. –û–±–Ω–æ–≤–ª—è–µ–º backend
echo "üîß –û–±–Ω–æ–≤–ª—è–µ–º backend..."
cd backend
npm install --production

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backend —Å–µ—Ä–≤–∏—Å
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backend —Å–µ—Ä–≤–∏—Å..."
sudo systemctl restart 1337-backend

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å backend
echo "üì° –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å backend —Å–µ—Ä–≤–∏—Å–∞..."
if sudo systemctl is-active --quiet 1337-backend; then
    echo "‚úÖ Backend —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ùå Backend —Å–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏..."
    sudo journalctl -u 1337-backend -n 10 --no-pager
    exit 1
fi

# 5. –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ endpoints
echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–µ endpoints..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º endpoint –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
if curl -s -w "%{http_code}" "http://localhost:3000/api/users/recalculate-tournament-stats" -X POST | grep -q "401"; then
    echo "‚úÖ Endpoint –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Ç–≤–µ—á–∞–µ—Ç (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –Ω–æ—Ä–º–∞–ª—å–Ω–æ)"
else
    echo "‚ö†Ô∏è Endpoint –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º endpoint —Ç—É—Ä–Ω–∏—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
if curl -s -w "%{http_code}" "http://localhost:3000/api/users/tournaments" | grep -q "401"; then
    echo "‚úÖ Endpoint —Ç—É—Ä–Ω–∏—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–≤–µ—á–∞–µ—Ç (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –Ω–æ—Ä–º–∞–ª—å–Ω–æ)"
else
    echo "‚ö†Ô∏è Endpoint —Ç—É—Ä–Ω–∏—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
fi

# 6. –û–±–Ω–æ–≤–ª—è–µ–º frontend
echo "üé® –û–±–Ω–æ–≤–ª—è–µ–º frontend..."
cd ../frontend
npm install --production
npm run build

# 7. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx
echo "üåê –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx..."
sudo systemctl reload nginx

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å nginx
echo "üì° –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å nginx..."
if sudo systemctl is-active --quiet nginx; then
    echo "‚úÖ Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ùå Nginx –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    sudo systemctl status nginx --no-pager -l
    exit 1
fi

# 8. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ backend –Ω–∞ –æ—à–∏–±–∫–∏..."
RECENT_ERRORS=$(sudo journalctl -u 1337-backend -n 20 --no-pager | grep -i "error" | wc -l)
if [ "$RECENT_ERRORS" -eq 0 ]; then
    echo "‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
else
    echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ $RECENT_ERRORS –æ—à–∏–±–æ–∫ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 20 –∑–∞–ø–∏—Å—è—Ö –ª–æ–≥–∞"
    echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏:"
    sudo journalctl -u 1337-backend -n 5 --no-pager | grep -i "error" || echo "–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
fi

# 9. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã user_tournament_stats..."
if command -v psql &> /dev/null; then
    TABLE_STATUS=$(psql -U postgres -d 1337community -t -c "
        SELECT CASE 
            WHEN EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'user_tournament_stats') 
            THEN 'EXISTS' 
            ELSE 'MISSING' 
        END;
    " 2>/dev/null | tr -d ' ')
    
    if [ "$TABLE_STATUS" = "EXISTS" ]; then
        RECORD_COUNT=$(psql -U postgres -d 1337community -t -c "SELECT COUNT(*) FROM user_tournament_stats;" 2>/dev/null | tr -d ' ')
        echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ user_tournament_stats —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç $RECORD_COUNT –∑–∞–ø–∏—Å–µ–π"
    else
        echo "‚ùå –¢–∞–±–ª–∏—Ü–∞ user_tournament_stats –ù–ï –ù–ê–ô–î–ï–ù–ê!"
        exit 1
    fi
else
    echo "‚ö†Ô∏è –ù–µ –º–æ–≥—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É - PostgreSQL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

echo ""
echo "üéâ –§–ò–ù–ê–õ–¨–ù–´–ô –î–ï–ü–õ–û–ô –°–¢–ê–¢–ò–°–¢–ò–ö–ò v2.0 –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!"
echo ""
echo "üìä –ò–¢–û–ì–ò –£–õ–£–ß–®–ï–ù–ò–ô:"
echo "   üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ç—É—Ä–Ω–∏—Ä–æ–≤"
echo "   üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π UPSERT –≤–º–µ—Å—Ç–æ DELETE+INSERT (–≤ 2 –º–µ—Å—Ç–∞—Ö)"
echo "   üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã: '–û–±–Ω–æ–≤–ª–µ–Ω–æ: X –∏–∑ Y —Ç—É—Ä–Ω–∏—Ä–æ–≤'"
echo "   üéØ –£–ª—É—á—à–µ–Ω–Ω—ã–π error handling —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏"
echo "   üìä –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π JOIN –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç—É—Ä–Ω–∏—Ä–æ–≤"
echo "   üé® Real-time –ø–æ–∫–∞–∑ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ (3 —Ñ–∞–∑—ã)"
echo "   ‚ö° Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö"
echo ""
echo "üîó –ü–†–û–í–ï–†–ò–¢–¨ –†–ï–ó–£–õ–¨–¢–ê–¢:"
echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ https://1337community.com/profile"
echo "   2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'"
echo "   3. –£–≤–∏–¥–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å: 'üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç—É—Ä–Ω–∏—Ä–æ–≤...'"
echo "   4. –ó–∞—Ç–µ–º: '‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: X –∏–∑ Y —Ç—É—Ä–Ω–∏—Ä–æ–≤'"
echo "   5. –§–∏–Ω–∞–ª: '‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞'"
echo "   6. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É '–¢—É—Ä–Ω–∏—Ä—ã'"
echo "   7. –í –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–∞—Ö —É–≤–∏–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã!"
echo ""
echo "üèÜ –ü–†–û–ë–õ–ï–ú–ê \"–ù–ï –£–ö–ê–ó–ê–ù\" –í –†–ï–ó–£–õ–¨–¢–ê–¢–ê–• –¢–£–†–ù–ò–†–û–í –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–®–ï–ù–ê!"
echo "üíé –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —á–∞—Å—ã ‚è∞"

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd .. 