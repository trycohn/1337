# Инструкция по исправлению WebSocket на VDS

## Проблема
WebSocket соединения падают с ошибкой 400 Bad Request при попытке upgrade соединения.

## Шаги для исправления

### 1. Подключитесь к серверу
```bash
ssh root@80.87.200.23
# Пароль: 01012006Fortnite!
```

### 2. Перейдите в директорию проекта
```bash
cd /var/www/1337community.com
```

### 3. Создайте скрипт исправления
```bash
nano websocket_final_fix.sh
```

Скопируйте содержимое файла `websocket_final_fix.sh` и вставьте в nano (Ctrl+Shift+V).
Сохраните: Ctrl+X, затем Y, затем Enter.

### 4. Сделайте скрипт исполняемым
```bash
chmod +x websocket_final_fix.sh
```

### 5. Запустите скрипт
```bash
./websocket_final_fix.sh
```

### 6. Проверьте результаты
Скрипт выполнит:
- Диагностику текущей конфигурации
- Создание резервной копии
- Применение исправлений
- Перезагрузку nginx
- Тестирование Socket.IO

### 7. Проверьте в браузере
1. Очистите кэш браузера (Ctrl+F5)
2. Откройте https://1337community.com
3. Перейдите в любой турнир
4. Откройте консоль разработчика (F12)
5. WebSocket ошибки должны исчезнуть

## Что делает скрипт
1. **Отключает HTTP/2** - критично для WebSocket
2. **Добавляет map директиву** - для правильного upgrade
3. **Настраивает правильные заголовки** - Upgrade, Connection
4. **Отключает буферизацию** - для real-time соединений
5. **Увеличивает таймауты** - для стабильности

## Если проблема остается
Проверьте логи:
```bash
# Логи nginx
tail -f /var/log/nginx/error.log

# Логи backend
pm2 logs 1337-backend --lines 50
```

## Что делают исправления

1. **Обновляют конфигурацию nginx**:
   - Правильная настройка proxy для WebSocket
   - Отключение буферизации
   - Увеличение таймаутов
   - Добавление CORS заголовков

2. **Добавляют map директиву**:
   - Необходима для правильного upgrade соединения
   - Определяет значение заголовка Connection

3. **Перезапускают сервисы**:
   - nginx для применения новой конфигурации
   - backend для сброса соединений

## Если проблема сохраняется

1. Проверьте, что backend слушает на порту 3000:
   ```bash
   netstat -tlnp | grep :3000
   ```

2. Проверьте конфигурацию Socket.IO в backend:
   ```bash
   grep -A 10 "const io = new Server" /var/www/1337community.com/backend/server.js
   ```

3. Убедитесь, что в server.js есть правильный path:
   ```javascript
   const io = new Server(server, {
     cors: {
       origin: process.env.FRONTEND_URL || "https://1337community.com",
       credentials: true
     },
     path: '/socket.io/'  // Важно!
   });
   ```

4. Проверьте firewall:
   ```bash
   ufw status
   ```

## Контакты для помощи
Если проблема не решается, сохраните все логи и вывод диагностики. 