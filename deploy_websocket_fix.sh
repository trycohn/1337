#!/bin/bash

# üöÄ –°–∫—Ä–∏–ø—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π WebSocket –Ω–∞ VDS
# –î–∞—Ç–∞: $(date)
# –û–ø–∏—Å–∞–Ω–∏–µ: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–µ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Ç—É—Ä–Ω–∏—Ä–∞

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π WebSocket..."

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /var/www/1337community.com

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
CURRENT_BRANCH=$(git branch --show-current)
echo "üìç –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $CURRENT_BRANCH"

# –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø
echo "üíæ –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø..."
cp -r backend backend_backup_$(date +%Y%m%d_%H%M%S)
cp -r frontend frontend_backup_$(date +%Y%m%d_%H%M%S)

# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo "üì• –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
git fetch origin
git pull origin $CURRENT_BRANCH

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Ñ–∞–π–ª–æ–≤..."
git status

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backend
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backend..."
pm2 restart 1337-backend

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å backend
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å backend..."
pm2 status 1337-backend

# –û–±–Ω–æ–≤–ª—è–µ–º frontend (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è build)
if [ -d "frontend/build" ]; then
    echo "üèóÔ∏è –û–±–Ω–æ–≤–ª—è–µ–º frontend build..."
    cd frontend
    npm run build
    cd ..
fi

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx (–µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)
echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx..."
sudo nginx -t && sudo systemctl reload nginx

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ backend
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ backend:"
pm2 logs 1337-backend --lines 20

echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üîç –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ WebSocket –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:"
echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ç—É—Ä–Ω–∏—Ä –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
echo "2. –ù–∞–∂–º–∏—Ç–µ '–ù–∞—á–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä'"
echo "3. –°—Ç–∞—Ç—É—Å –¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–∏—Ç—å—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ"
echo ""
echo "üìä –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ WebSocket:"
echo "GET /api/tournaments/websocket/stats" 