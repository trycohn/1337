#!/bin/bash

# üîß –°–∫—Ä–∏–ø—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π WebSocket Socket.IO v2.0
# –ê–≤—Ç–æ—Ä: 1337 Community Development Team
# –î–∞—Ç–∞: 2025-01-22
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: Backend Socket.IO + ALL Frontend Socket.IO –∫–ª–∏–µ–Ω—Ç—ã

echo "üöÄ –ù–∞—á–∏–Ω–∞—é —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π WebSocket Socket.IO v2.0..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "backend/server.js" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 stop 1337-backend 2>/dev/null || echo "‚ÑπÔ∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –±—ã–ª–æ –∑–∞–ø—É—â–µ–Ω–æ —á–µ—Ä–µ–∑ PM2"

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitHub..."
git stash push -m "–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º $(date)"
git pull origin main

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–¥–∞ –∏–∑ GitHub"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ package.json
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
if git diff HEAD~1 --name-only | grep -q "package.json"; then
    echo "üì¶ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ package.json, –æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    
    # Backend –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    if [ -f "backend/package.json" ]; then
        echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ backend –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
        cd backend
        npm install
        cd ..
    fi
    
    # Frontend –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    if [ -f "frontend/package.json" ]; then
        echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ frontend –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
        cd frontend
        npm install
        cd ..
    fi
else
    echo "‚ÑπÔ∏è –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å"
fi

# –°–±–æ—Ä–∫–∞ frontend (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Socket.IO –∫–ª–∏–µ–Ω—Ç–∞—Ö)
echo "üî® –°–±–æ—Ä–∫–∞ frontend —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ Socket.IO –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏..."
cd frontend
npm run build

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ frontend"
    cd ..
    exit 1
fi
cd ..

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ WebSocket –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ WebSocket –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ backend –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
if grep -q "withCredentials" backend/server.js; then
    echo "‚úÖ Backend: server.js —Å–æ–¥–µ—Ä–∂–∏—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Socket.IO"
else
    echo "‚ö†Ô∏è Backend: server.js –º–æ–∂–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ frontend –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ frontend –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π..."

if grep -q "withCredentials.*true" frontend/src/hooks/tournament/useWebSocket.js; then
    echo "‚úÖ Frontend: useWebSocket.js –∏—Å–ø—Ä–∞–≤–ª–µ–Ω"
else
    echo "‚ö†Ô∏è Frontend: useWebSocket.js –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π"
fi

if grep -q "withCredentials.*true" frontend/src/components/Layout.js; then
    echo "‚úÖ Frontend: Layout.js –∏—Å–ø—Ä–∞–≤–ª–µ–Ω"
else
    echo "‚ö†Ô∏è Frontend: Layout.js –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π"
fi

if grep -q "withCredentials.*true" frontend/src/components/TournamentDetails.js; then
    echo "‚úÖ Frontend: TournamentDetails.js –∏—Å–ø—Ä–∞–≤–ª–µ–Ω"
else
    echo "‚ö†Ô∏è Frontend: TournamentDetails.js –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π"
fi

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 start backend/server.js --name "1337-backend"

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    exit 1
fi

# –û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (10 —Å–µ–∫—É–Ω–¥)..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 status 1337-backend

# –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
pm2 logs 1337-backend --lines 20

echo ""
echo "üéâ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ WebSocket –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π v2.0 –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üìã –í–ê–ñ–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ:"
echo "1. üåê –û—Ç–∫—Ä–æ–π—Ç–µ https://1337community.com –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
echo "2. üîß –û—Ç–∫—Ä–æ–π—Ç–µ Developer Tools (F12)"
echo "3. üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π:"
echo "   ‚úÖ '‚úÖ Socket.IO ... —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'"
echo "   ‚úÖ '‚úÖ Layout: WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'"
echo "   ‚úÖ '‚úÖ Socket.IO —Ç—É—Ä–Ω–∏—Ä —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'"
echo "4. üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∫–ª–∞–¥–∫—É Network ‚Üí WS –Ω–∞ –Ω–∞–ª–∏—á–∏–µ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π"
echo "5. üí¨ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —á–∞—Ç –≤ –ª—é–±–æ–º —Ç—É—Ä–Ω–∏—Ä–µ"
echo "6. üîî –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
echo ""
echo "üîß –ï–°–õ–ò –ü–†–û–ë–õ–ï–ú–´ –û–°–¢–ê–Æ–¢–°–Ø:"
echo "1. –û—á–∏—Å—Ç–∏—Ç–µ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞ (Ctrl+Shift+R)"
echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é: cat websocket_nginx_config.md"
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Nginx: sudo tail -f /var/log/nginx/error.log"
echo "4. –°–≤—è–∂–∏—Ç–µ—Å—å —Å DevOps –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Nginx proxy"
echo ""
echo "üìä –ü—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
echo "- ‚úÖ Backend Socket.IO —Å–µ—Ä–≤–µ—Ä: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ CORS + —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ã + —Ç–∞–π–º–∞—É—Ç—ã"
echo "- ‚úÖ Frontend useWebSocket.js: window.location.origin + withCredentials"
echo "- ‚úÖ Frontend Layout.js: withCredentials + –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã"
echo "- ‚úÖ Frontend TournamentDetails.js: websocket+polling —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ã"
echo "- ‚úÖ Frontend Messenger.js: —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
echo ""
echo "üéØ –í—Å–µ Socket.IO –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã!" 