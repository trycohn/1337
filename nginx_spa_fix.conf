# üîß Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è SPA (React Router)
# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: /etc/nginx/sites-available/1337community.com

server {
    listen 80;
    listen [::]:80;
    server_name 1337community.com www.1337community.com;
    
    # –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name 1337community.com www.1337community.com;

    # SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/1337community.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/1337community.com/privkey.pem;

    # –ö–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
    root /var/www/1337community.com/frontend/build;
    index index.html;

    # –õ–æ–≥–∏
    access_log /var/log/nginx/1337community_access.log;
    error_log /var/log/nginx/1337community_error.log;

    # ==========================================
    # üéØ BACKEND API –ò SOCKET.IO
    # ==========================================
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 90s;
        proxy_connect_timeout 90s;
        proxy_send_timeout 90s;
    }

    # Socket.IO –¥–ª—è WebSocket
    location /socket.io/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_buffering off;
    }

    # ==========================================
    # üé® –°–¢–ê–¢–ò–ß–ï–°–ö–ò–ï –§–ê–ô–õ–´ –§–†–û–ù–¢–ï–ù–î–ê
    # ==========================================
    location /static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location /images/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ==========================================
    # üîß SPA ROUTING (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û!)
    # ==========================================
    # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–¥–∞–µ–º —á–µ—Ä–µ–∑ index.html
    # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç React Router –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã
    location / {
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache";
    }

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
    location ~ /\. {
        deny all;
    }
}

