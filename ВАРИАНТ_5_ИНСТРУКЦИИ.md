# ๐ ะะะะะะะข 5: DUAL-SERVER ะะะจะะะะ HTTP/2 + WEBSOCKET

## ๐ ะะฟะธัะฐะฝะธะต ัะตัะตะฝะธั

**ะะฐัะธะฐะฝั 5** ัะตัะฐะตั ััะฝะดะฐะผะตะฝัะฐะปัะฝัั ะฟัะพะฑะปะตะผั ะฝะตัะพะฒะผะตััะธะผะพััะธ HTTP/2 ั WebSocket upgrade, ะธัะฟะพะปัะทัั ะฐััะธัะตะบัััั dual-server:

- **ะะพัั 443 (HTTP/2)**: ะัะฝะพะฒะฝะพะน ััะฐัะธะบ (API, ััะฐัะธัะตัะบะธะต ัะฐะนะปั)
- **ะะพัั 8443 (HTTP/1.1)**: ะญะบัะบะปัะทะธะฒะฝะพ ะดะปั WebSocket ัะพะตะดะธะฝะตะฝะธะน

## ๐ฏ ะััะธัะตะบัััะฐ ัะตัะตะฝะธั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              ะะะะฃะะะ                    โ
โ    (HTTP/2 + WebSocket ะบะปะธะตะฝั)          โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
        โโโโโโโโโโโดโโโโโโโโโโโ
        โ                    โ
        โผ                    โผ
โโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ NGINX :443  โ    โ  NGINX :8443    โ
โ  (HTTP/2)   โ    โ  (HTTP/1.1)     โ
โ  - API      โ    โ  - Socket.IO    โ
โ  - Static   โ    โ  - WebSocket    โ
โโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
        โ                    โ
        โโโโโโโโโโโฌโโโโโโโโโโโ
                  โผ
        โโโโโโโโโโโโโโโโโโโ
        โ  BACKEND :3000  โ
        โ  (Node.js +     โ
        โ   Socket.IO)    โ
        โโโโโโโโโโโโโโโโโโโ
```

## ๐ง ะะพะผะฐะฝะดั ะฟัะธะผะตะฝะตะฝะธั ะฝะฐ VDS ัะตัะฒะตัะต

### 1. ะะพะดะบะปััะตะฝะธะต ะบ ัะตัะฒะตัั
```bash
ssh root@80.87.200.23
# ะะฐัะพะปั: 01012006Fortnite!
```

### 2. ะะตัะตัะพะด ะฒ ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ
```bash
cd /var/www/1337community.com
```

### 3. ะะพะปััะตะฝะธะต ะฟะพัะปะตะดะฝะธั ะธะทะผะตะฝะตะฝะธะน
```bash
git pull origin main
```

### 4. ะัะธะผะตะฝะตะฝะธะต ะะฐัะธะฐะฝัะฐ 5
```bash
# ะะตะปะฐะตะผ ัะบัะธะฟั ะธัะฟะพะปะฝัะตะผัะผ
chmod +x websocket_http2_fix_v5.sh

# ะะฐะฟััะบะฐะตะผ ะฐะฒัะพะผะฐัะธัะตัะบะพะต ะฟัะธะผะตะฝะตะฝะธะต
./websocket_http2_fix_v5.sh
```

## ๐ ะงัะพ ะดะตะปะฐะตั ัะบัะธะฟั ะฐะฒัะพะผะฐัะธัะตัะบะธ

### โ ะกะพะทะดะฐะฝะธะต ะบะพะฝัะธะณััะฐัะธะธ Nginx:
- **Dual-server setup**: ะดะฒะฐ server ะฑะปะพะบะฐ ะฝะฐ ะฟะพััะฐั 443 ะธ 8443
- **HTTP/2 ะดะปั ะพัะฝะพะฒะฝะพะณะพ ััะฐัะธะบะฐ**: ะผะฐะบัะธะผะฐะปัะฝะฐั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั
- **HTTP/1.1 ะดะปั WebSocket**: ะฟะพะปะฝะฐั ัะพะฒะผะตััะธะผะพััั
- **ะะฒัะพะผะฐัะธัะตัะบะธะน redirect**: `/socket.io/` โ ะฟะพัั 8443

### โ ะะฑะฝะพะฒะปะตะฝะธะต backend ะบะพะฝัะธะณััะฐัะธะธ:
- ะกะพะทะดะฐะฝะธะต ะฟะฐััะฐ ั ะพะฑะฝะพะฒะปะตะฝะฝัะผะธ ะฝะฐัััะพะนะบะฐะผะธ Socket.IO
- CORS ะบะพะฝัะธะณััะฐัะธั ะดะปั dual-port setup
- Production-ready ะฟะฐัะฐะผะตััั ัะพะตะดะธะฝะตะฝะธั

### โ ะกะพะทะดะฐะฝะธะต ะฝะพะฒะพะณะพ frontend ะบะปะธะตะฝัะฐ:
- ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฟัะตะดะตะปะตะฝะธะต ะฟัะฐะฒะธะปัะฝะพะณะพ ะฟะพััะฐ
- Fallback ะผะตะถะดั WebSocket ะธ polling
- Debug ะปะพะณะธัะพะฒะฐะฝะธะต ะดะปั ะผะพะฝะธัะพัะธะฝะณะฐ

### โ ะะฒัะพะผะฐัะธัะตัะบะพะต ัะตััะธัะพะฒะฐะฝะธะต:
- ะัะพะฒะตัะบะฐ ัะธะฝัะฐะบัะธัะฐ Nginx
- ะขะตััะธัะพะฒะฐะฝะธะต HTTP/2 endpoint (ะฟะพัั 443)
- ะขะตััะธัะพะฒะฐะฝะธะต WebSocket endpoint (ะฟะพัั 8443)
- ะะตัะธัะธะบะฐัะธั Socket.IO JSON ะพัะฒะตัะฐ

## ๐ฏ ะะถะธะดะฐะตะผัะต ัะตะทัะปััะฐัั

ะะพัะปะต ััะฟะตัะฝะพะณะพ ะฟัะธะผะตะฝะตะฝะธั:

```
โ ะัะฝะพะฒะฝะพะน ััะฐัะธะบ: HTTPS/HTTP2 ะฝะฐ ะฟะพััั 443
โ WebSocket ััะฐัะธะบ: HTTPS/HTTP1.1 ะฝะฐ ะฟะพััั 8443
โ Socket.IO ััะฐะฝัะฟะพััั: [websocket, polling]
โ ะะฒัะพะผะฐัะธัะตัะบะธะน fallback ะฟัะธ ะฟัะพะฑะปะตะผะฐั ั WebSocket
```

## ๐งช ะัะพะฒะตัะบะฐ ัะตะทัะปััะฐัะพะฒ

### ะ ะฑัะฐัะทะตัะต:
1. ะัะบัะพะนัะต `https://1337community.com`
2. ะัะบัะพะนัะต DevTools (F12) โ Network โ WS
3. ะัะพะฒะตัััะต WebSocket ัะพะตะดะธะฝะตะฝะธั ะบ ะฟะพััั 8443
4. Socket.IO ะดะพะปะถะตะฝ ะฟะพะดะบะปััะฐัััั ัะตัะตะท WebSocket ะธะปะธ polling

### ะงะตัะตะท ะบะพะผะฐะฝะดั:
```bash
# ะขะตัั ะพัะฝะพะฒะฝะพะณะพ API (HTTP/2)
curl https://1337community.com/api/

# ะขะตัั Socket.IO (HTTP/1.1)
curl https://1337community.com:8443/socket.io/

# ะขะตัั Socket.IO JSON ะพัะฒะตัะฐ
curl https://1337community.com/test-socketio

# ะัะพะฒะตัะบะฐ ะฐะบัะธะฒะฝัั ะฟะพััะพะฒ
ss -tlnp | grep nginx | grep -E ":(443|8443)"
```

## ๐ ะะธะฐะณะฝะพััะธะบะฐ ะฟัะพะฑะปะตะผ

### ะะพะณะธ:
```bash
# Nginx ะปะพะณะธ
tail -f /var/log/nginx/error.log

# Backend ะปะพะณะธ
pm2 logs 1337-backend

# ะกะธััะตะผะฝัะต ะปะพะณะธ
journalctl -u nginx -f
```

### ะขะธะฟะธัะฝัะต ะฟัะพะฑะปะตะผั ะธ ัะตัะตะฝะธั:

#### โ Nginx ะฝะต ัะปััะฐะตั ะฟะพัั 8443
```bash
# ะัะพะฒะตัะธัั ะบะพะฝัะธะณััะฐัะธั
nginx -t

# ะะตัะตะทะฐะฟัััะธัั nginx
systemctl restart nginx
```

#### โ Backend ะฝะตะดะพัััะฟะตะฝ
```bash
# ะัะพะฒะตัะธัั ััะฐััั PM2
pm2 status

# ะะตัะตะทะฐะฟัััะธัั backend
pm2 restart 1337-backend
```

#### โ SSL ัะตััะธัะธะบะฐั
```bash
# ะัะพะฒะตัะธัั ัะตััะธัะธะบะฐั
certbot certificates

# ะะฑะฝะพะฒะธัั ัะตััะธัะธะบะฐั
certbot renew
```

## ๐ ะัะบะฐั ะบ ะฟัะตะดัะดััะตะน ะฒะตััะธะธ

ะัะปะธ ะฒะพะทะฝะธะบะปะธ ะฟัะพะฑะปะตะผั:

```bash
# ะะพัััะฐะฝะพะฒะธัั backup ะบะพะฝัะธะณััะฐัะธะธ Nginx
cp /etc/nginx/sites-available/1337community.com.backup.v5.* /etc/nginx/sites-available/1337community.com

# ะะพัััะฐะฝะพะฒะธัั backup backend
cp /var/www/1337community.com/backend/server.js.backup.v5.* /var/www/1337community.com/backend/server.js

# ะะตัะตะทะฐะณััะทะธัั ัะตัะฒะธัั
nginx -t && systemctl reload nginx
pm2 restart 1337-backend
```

## ๐ ะัะตะธะผััะตััะฒะฐ ะะฐัะธะฐะฝัะฐ 5

### ๐ ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั:
- HTTP/2 ะดะปั ะพัะฝะพะฒะฝะพะณะพ ััะฐัะธะบะฐ (multiplexing, compression)
- ะะฟัะธะผะธะทะธัะพะฒะฐะฝะฝะฐั ะดะพััะฐะฒะบะฐ ััะฐัะธัะตัะบะธั ัะฐะนะปะพะฒ
- ะะธะฝะธะผะฐะปัะฝะฐั ะปะฐัะตะฝัะฝะพััั ะดะปั API ะทะฐะฟัะพัะพะฒ

### ๐ ะกะพะฒะผะตััะธะผะพััั WebSocket:
- 100% ัะพะฒะผะตััะธะผะพััั ั WebSocket upgrade
- ะะฒัะพะผะฐัะธัะตัะบะธะน fallback ะฝะฐ polling
- ะกัะฐะฑะธะปัะฝัะต real-time ัะพะตะดะธะฝะตะฝะธั

### ๐ก๏ธ ะะตะทะพะฟะฐัะฝะพััั:
- ะกะพะฒัะตะผะตะฝะฝัะต SSL/TLS ะฝะฐัััะพะนะบะธ
- Security headers ะดะปั ะฒัะตั endpoints
- ะะทะพะปััะธั WebSocket ััะฐัะธะบะฐ

### ๐ง ะะฑัะปัะถะธะฒะฐะฝะธะต:
- ะัะพััะฐั ะดะธะฐะณะฝะพััะธะบะฐ ะฟัะพะฑะปะตะผ
- ะะตะทะฐะฒะธัะธะผะพะต ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต ะฟะพััะพะฒ
- ะะธะฑะบะฐั ะบะพะฝัะธะณััะฐัะธั ะดะปั ัะฐะทะปะธัะฝัั ััะตะฝะฐัะธะตะฒ

## ๐ ะะพะดะดะตัะถะบะฐ

ะัะธ ะฒะพะทะฝะธะบะฝะพะฒะตะฝะธะธ ะฟัะพะฑะปะตะผ:

1. ะัะพะฒะตัััะต ะฒัะต ะปะพะณะธ (nginx, pm2, system)
2. ะฃะฑะตะดะธัะตัั, ััะพ ะฟะพััั 443 ะธ 8443 ะพัะบัััั ะฒ firewall
3. ะัะพะฒะตัััะต SSL ัะตััะธัะธะบะฐัั
4. ะัะฟะพะปะฝะธัะต ะดะธะฐะณะฝะพััะธัะตัะบะธะต ะบะพะผะฐะฝะดั ะธะท ัะฐะทะดะตะปะฐ "ะัะพะฒะตัะบะฐ ัะตะทัะปััะฐัะพะฒ"

**ะะฐัะธะฐะฝั 5 ะพะฑะตัะฟะตัะธะฒะฐะตั ะผะฐะบัะธะผะฐะปัะฝัั ัะพะฒะผะตััะธะผะพััั ะธ ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั ะดะปั 1337 Community Tournament Platform!** 