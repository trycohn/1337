# Исправление кнопки "Сбросить результаты матчей" - Развертывание на VDS

## Проблема
После нажатия кнопки "Начать турнир" должна появиться кнопка "Сбросить результаты матчей" для администраторов и создателя турнира, но она не работала.

## Исправления

### 1. Frontend исправления (frontend/src/components/TournamentDetails.js)

**Проблема:** Функция `handleClearMatchResults` была заглушкой и только показывала toast с сообщением "Функция сброса результатов отключена".

**Исправления:**
- Заменена функция `handleClearMatchResults` на полноценную реализацию с API вызовом
- Добавлено состояние `showClearResultsModal` для модального окна подтверждения
- Добавлена функция `confirmClearMatchResults` для выполнения сброса результатов
- Добавлено модальное окно подтверждения с предупреждением о последствиях действия

### 2. Backend исправления (backend/routes/tournaments.js)

**Проблема:** Дублирующиеся маршруты для `clear-match-results` могли вызывать конфликты.

**Исправления:**
- Удален первый дублирующийся маршрут с неполной проверкой прав
- Оставлен только второй маршрут с правильной проверкой прав через `verifyAdminOrCreator`
- Маршрут корректно обновляет данные турнира и отправляет обновления через WebSocket

## Развертывание на VDS сервере

### Шаг 1: Подключение к серверу
```bash
ssh username@your-vds-server
cd /path/to/your/project
```

### Шаг 2: Получение обновлений
```bash
git pull origin main
```

### Шаг 3: Исправление backend (если есть дублирующиеся маршруты)
Проверьте файл `backend/routes/tournaments.js` на наличие дублирующихся маршрутов:
```bash
grep -n "clear-match-results" backend/routes/tournaments.js
```

Если есть два маршрута, удалите первый (строки примерно 1863-1911):
```bash
# Создайте резервную копию
cp backend/routes/tournaments.js backend/routes/tournaments.js.backup

# Удалите дублирующийся маршрут (замените номера строк на актуальные)
sed -i '1863,1911d' backend/routes/tournaments.js
```

### Шаг 4: Перезапуск backend сервера
```bash
# Если используется PM2
pm2 restart backend

# Если используется systemctl
sudo systemctl restart your-backend-service

# Если запускается вручную
cd backend
npm install  # если были изменения в зависимостях
node server.js
```

### Шаг 5: Сборка и развертывание frontend
```bash
cd frontend
npm install  # если были изменения в зависимостях
npm run build

# Копирование в директорию веб-сервера (например, Nginx)
sudo cp -r build/* /var/www/html/
# или
sudo rsync -av build/ /var/www/html/
```

### Шаг 6: Перезапуск веб-сервера
```bash
sudo systemctl reload nginx
# или
sudo systemctl restart nginx
```

### Шаг 7: Проверка логов
```bash
# Проверка логов backend
pm2 logs backend
# или
journalctl -u your-backend-service -f

# Проверка логов Nginx
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

## Проверка исправления

### 1. Проверка в браузере
1. Откройте турнир со сгенерированной сеткой
2. Нажмите кнопку "Начать турнир" (если турнир еще не начат)
3. Проверьте, что появилась кнопка "Сбросить результаты матчей"
4. Нажмите на кнопку и убедитесь, что появляется модальное окно подтверждения
5. Подтвердите действие и проверьте, что результаты матчей очищены

### 2. Проверка API
Проверьте, что API маршрут работает:
```bash
curl -X POST http://your-server/api/tournaments/TOURNAMENT_ID/clear-match-results \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json"
```

### 3. Проверка логов сервера
При сбросе результатов должны появиться логи:
```
Очистка результатов матчей для турнира TOURNAMENT_ID пользователем USER_ID
Очищены результаты N матчей для турнира TOURNAMENT_ID
```

## Функциональность

### Кнопка "Сбросить результаты матчей"
- **Видимость:** Отображается только для администраторов и создателя турнира
- **Условия:** Турнир должен быть в статусе "in_progress" и иметь сгенерированную сетку
- **Действие:** Очищает все результаты матчей (winner_team_id, score1, score2), но сохраняет структуру сетки
- **Подтверждение:** Требует подтверждения через модальное окно

### Модальное окно подтверждения
- **Заголовок:** "Подтверждение сброса результатов"
- **Предупреждение:** Объясняет последствия действия
- **Кнопки:** "Отмена" и "Сбросить результаты"

### API маршрут
- **Путь:** `POST /api/tournaments/:id/clear-match-results`
- **Права:** Только создатель турнира или администратор
- **Ответ:** Обновленные данные турнира
- **WebSocket:** Автоматически уведомляет всех клиентов об изменениях

## Откат изменений (если необходимо)

```bash
# Восстановление backend из резервной копии
cp backend/routes/tournaments.js.backup backend/routes/tournaments.js

# Откат через git
git log --oneline -5  # посмотреть последние коммиты
git revert <commit-hash>  # откатить конкретный коммит
git push origin main

# Затем повторить шаги развертывания
```

## Дополнительные проверки

### Проверка прав доступа
Убедитесь, что кнопка видна только:
- Создателю турнира
- Администраторам турнира
- Только для турниров в статусе "in_progress"

### Проверка безопасности
- API маршрут защищен middleware `verifyAdminOrCreator`
- Проверяется статус турнира перед выполнением действия
- Логируются все действия по сбросу результатов

## Контакты для поддержки
При возникновении проблем проверьте:
1. Логи сервера
2. Консоль браузера
3. Статус сервисов: `systemctl status nginx`, `pm2 status`
4. Доступность базы данных

Версия исправления: 1.0.3
Дата: 27.05.2025 