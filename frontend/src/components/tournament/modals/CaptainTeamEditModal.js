import React, { useState, useEffect, useCallback } from 'react';
import { DndProvider, useDrag, useDrop } from 'react-dnd';
import { HTML5Backend } from 'react-dnd-html5-backend';
import { TouchBackend } from 'react-dnd-touch-backend';
import { isMobile } from 'react-device-detect';
import api from '../../../utils/api';
import { ensureHttps } from '../../../utils/userHelpers';
import './CaptainTeamEditModal.css';

const ItemTypes = {
    PLAYER: 'player'
};

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–≥–æ –∏–≥—Ä–æ–∫–∞
const DraggablePlayer = ({ player, index, onMove, isRosterSlot, slotIndex, canDrag }) => {
    const [{ isDragging }, drag] = useDrag({
        type: ItemTypes.PLAYER,
        item: { player, sourceIndex: index, isFromRoster: isRosterSlot },
        canDrag: () => canDrag,
        collect: (monitor) => ({
            isDragging: monitor.isDragging()
        })
    });

    const [{ isOver }, drop] = useDrop({
        accept: ItemTypes.PLAYER,
        drop: (item) => {
            if (onMove) {
                onMove(item, { player, targetIndex: slotIndex, isRosterSlot });
            }
        },
        collect: (monitor) => ({
            isOver: monitor.isOver()
        })
    });

    const faceitElo = player?.faceit_elo || player?.user_faceit_elo || 1200;

    return (
        <div
            ref={(node) => drag(drop(node))}
            className={`ctem-draggable-player ${isDragging ? 'ctem-dragging' : ''} ${isOver ? 'ctem-drop-target' : ''}`}
            style={{ opacity: isDragging ? 0.5 : 1 }}
        >
            <div className="ctem-player-info">
                <img 
                    src={ensureHttps(player?.avatar_url) || '/uploads/avatars/preloaded/circle-user.svg'}
                    alt={player?.username || player?.name}
                    className="ctem-player-avatar"
                    onError={(e) => { e.currentTarget.src = '/uploads/avatars/preloaded/circle-user.svg'; }}
                />
                <div className="ctem-player-details">
                    <span className="ctem-player-name">
                        {player?.username || player?.name}
                        {player?.is_captain && <span className="ctem-captain-badge"> üëë</span>}
                    </span>
                    <span className="ctem-player-elo">FACEIT: {faceitElo}</span>
                </div>
            </div>
        </div>
    );
};

// –ü—É—Å—Ç–æ–π —Å–ª–æ—Ç –¥–ª—è —Ä–æ—Å—Ç–µ—Ä–∞
const EmptySlot = ({ slotIndex, onMove }) => {
    const [{ isOver }, drop] = useDrop({
        accept: ItemTypes.PLAYER,
        drop: (item) => {
            if (onMove) {
                onMove(item, { player: null, targetIndex: slotIndex, isRosterSlot: true });
            }
        },
        collect: (monitor) => ({
            isOver: monitor.isOver()
        })
    });

    return (
        <div
            ref={drop}
            className={`ctem-empty-slot ${isOver ? 'ctem-drop-target' : ''}`}
        >
            <span>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ —Å—é–¥–∞</span>
        </div>
    );
};

/**
 * –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–Ω–æ–≥–æ —Å–æ—Å—Ç–∞–≤–∞ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∫–∞–ø–∏—Ç–∞–Ω–∞
 */
const CaptainTeamEditModal = ({ 
    isOpen, 
    onClose, 
    team, 
    tournament,
    user,
    onSuccess 
}) => {
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const [success, setSuccess] = useState('');
    
    // –î–∞–Ω–Ω—ã–µ
    const [tournamentRoster, setTournamentRoster] = useState([]);
    const [availablePlayers, setAvailablePlayers] = useState([]);
    const [globalTeam, setGlobalTeam] = useState(null);
    const [maxTeamSize, setMaxTeamSize] = useState(5);

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    useEffect(() => {
        if (isOpen && team?.id && tournament?.id) {
            loadData();
        }
    }, [isOpen, team?.id, tournament?.id]);

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—É—Ä–Ω–∏—Ä–Ω–æ–≥–æ —Å–æ—Å—Ç–∞–≤–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
    const loadData = async () => {
        try {
            setLoading(true);
            setError('');
            
            const token = localStorage.getItem('token');
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç—É—Ä–Ω–∏—Ä–Ω—ã–π —Å–æ—Å—Ç–∞–≤
            const rosterResponse = await api.get(
                `/api/tournaments/${tournament.id}/teams/${team.id}/members`,
                { headers: { Authorization: `Bearer ${token}` } }
            );

            // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã
            const globalResponse = await api.get(
                `/api/tournaments/${tournament.id}/teams/${team.id}/global-roster`,
                { headers: { Authorization: `Bearer ${token}` } }
            );

            if (rosterResponse.data.success) {
                // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–∞–ø–∏—Ç–∞–Ω–∞ –∏–∑ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ —Å–æ—Å—Ç–∞–≤–∞
                const nonCaptainMembers = rosterResponse.data.members.filter(m => !m.is_captain);
                setTournamentRoster(nonCaptainMembers);
            }

            if (globalResponse.data.success) {
                setAvailablePlayers(globalResponse.data.availablePlayers || []);
                setGlobalTeam(globalResponse.data.globalTeam);
                setMaxTeamSize(globalResponse.data.maxTeamSize || 5);
            }

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', err);
            setError(err.response?.data?.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        } finally {
            setLoading(false);
        }
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞
    const handleMove = useCallback((draggedItem, dropTarget) => {
        const { player: draggedPlayer, isFromRoster: dragFromRoster } = draggedItem;
        const { player: targetPlayer, isRosterSlot: dropToRoster } = dropTarget;

        console.log('üîÑ –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞:', {
            from: dragFromRoster ? 'roster' : 'available',
            to: dropToRoster ? 'roster' : 'available',
            draggedPlayer: draggedPlayer?.username,
            targetPlayer: targetPlayer?.username
        });

        // –ò–∑ —Ä–æ—Å—Ç–µ—Ä–∞ –≤ –¥–æ—Å—Ç—É–ø–Ω—ã–µ
        if (dragFromRoster && !dropToRoster) {
            setTournamentRoster(prev => prev.filter(p => p.user_id !== draggedPlayer.user_id));
            setAvailablePlayers(prev => [...prev, draggedPlayer]);
        }
        // –ò–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤ —Ä–æ—Å—Ç–µ—Ä
        else if (!dragFromRoster && dropToRoster) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
            if (tournamentRoster.length >= maxTeamSize) {
                setError(`–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∫–æ–º–∞–Ω–¥—ã (${maxTeamSize} –∏–≥—Ä–æ–∫–æ–≤)`);
                setTimeout(() => setError(''), 3000);
                return;
            }

            // –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–º–µ–Ω–∞ (–µ—Å—Ç—å target –∏–≥—Ä–æ–∫)
            if (targetPlayer) {
                // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏
                setTournamentRoster(prev => 
                    prev.map(p => p.user_id === targetPlayer.user_id ? draggedPlayer : p)
                );
                setAvailablePlayers(prev => [
                    ...prev.filter(p => p.user_id !== draggedPlayer.user_id),
                    targetPlayer
                ]);
            } else {
                // –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º
                setTournamentRoster(prev => [...prev, draggedPlayer]);
                setAvailablePlayers(prev => prev.filter(p => p.user_id !== draggedPlayer.user_id));
            }
        }
        // Swap –≤–Ω—É—Ç—Ä–∏ —Ä–æ—Å—Ç–µ—Ä–∞
        else if (dragFromRoster && dropToRoster && targetPlayer) {
            const dragIndex = tournamentRoster.findIndex(p => p.user_id === draggedPlayer.user_id);
            const dropIndex = tournamentRoster.findIndex(p => p.user_id === targetPlayer.user_id);
            
            const newRoster = [...tournamentRoster];
            [newRoster[dragIndex], newRoster[dropIndex]] = [newRoster[dropIndex], newRoster[dragIndex]];
            setTournamentRoster(newRoster);
        }
    }, [tournamentRoster, maxTeamSize]);

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    const handleSave = async () => {
        try {
            setLoading(true);
            setError('');
            
            const token = localStorage.getItem('token');
            const memberUserIds = tournamentRoster.map(p => p.user_id);

            const response = await api.put(
                `/api/tournaments/${tournament.id}/teams/${team.id}/roster`,
                { memberUserIds },
                { headers: { Authorization: `Bearer ${token}` } }
            );

            if (response.data.success) {
                setSuccess('‚úÖ –°–æ—Å—Ç–∞–≤ –∫–æ–º–∞–Ω–¥—ã –æ–±–Ω–æ–≤–ª–µ–Ω!');
                setTimeout(() => {
                    if (onSuccess) onSuccess();
                    onClose();
                }, 1500);
            }

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err);
            setError(err.response?.data?.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π');
        } finally {
            setLoading(false);
        }
    };

    if (!isOpen) return null;

    const backend = isMobile ? TouchBackend : HTML5Backend;

    return (
        <DndProvider backend={backend}>
            <div className="modal-overlay" onClick={onClose}>
                <div 
                    className="ctem-modal"
                    onClick={(e) => e.stopPropagation()}
                >
                    <div className="ctem-modal-header">
                        <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–∞ "{team?.name}"</h3>
                        <button className="ctem-close-btn" onClick={onClose}>‚úï</button>
                    </div>

                    {error && <div className="ctem-error-message">{error}</div>}
                    {success && <div className="ctem-success-message">{success}</div>}

                    {!globalTeam && !loading && (
                        <div className="ctem-info-message">
                            –£ –≤–∞—Å –Ω–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã. –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ —Ä–∞–∑–¥–µ–ª–µ "–ú–æ–∏ –∫–æ–º–∞–Ω–¥—ã" —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º —Å–æ—Å—Ç–∞–≤–æ–º.
                        </div>
                    )}

                    <div className="ctem-modal-body">
                        {/* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –¢—É—Ä–Ω–∏—Ä–Ω—ã–π —Ä–æ—Å—Ç–µ—Ä */}
                        <div className="ctem-roster-column">
                            <h4>üë• –¢—É—Ä–Ω–∏—Ä–Ω—ã–π —Å–æ—Å—Ç–∞–≤ ({tournamentRoster.length}/{maxTeamSize})</h4>
                            <p className="ctem-column-hint">–ò–≥—Ä–æ–∫–∏, –∑–∞—è–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞ —Ç—É—Ä–Ω–∏—Ä</p>
                            
                            <div className="ctem-roster-slots">
                                {Array.from({ length: maxTeamSize }).map((_, index) => {
                                    const player = tournamentRoster[index];
                                    
                                    return player ? (
                                        <DraggablePlayer
                                            key={player.user_id}
                                            player={player}
                                            index={index}
                                            slotIndex={index}
                                            onMove={handleMove}
                                            isRosterSlot={true}
                                            canDrag={!loading}
                                        />
                                    ) : (
                                        <EmptySlot 
                                            key={`empty-${index}`}
                                            slotIndex={index}
                                            onMove={handleMove}
                                        />
                                    );
                                })}
                            </div>

                            <div className="ctem-roster-stats">
                                <div className="ctem-stat-item">
                                    <span className="ctem-stat-label">Œ£ FACEIT ELO:</span>
                                    <span className="ctem-stat-value">
                                        {tournamentRoster.reduce((sum, p) => sum + (p.faceit_elo || p.user_faceit_elo || 1200), 0).toLocaleString('ru-RU')}
                                    </span>
                                </div>
                                <div className="ctem-stat-item">
                                    <span className="ctem-stat-label">‚åÄ FACEIT ELO:</span>
                                    <span className="ctem-stat-value">
                                        {tournamentRoster.length > 0 
                                            ? Math.round(tournamentRoster.reduce((sum, p) => sum + (p.faceit_elo || p.user_faceit_elo || 1200), 0) / tournamentRoster.length)
                                            : 0
                                        }
                                    </span>
                                </div>
                            </div>
                        </div>

                        {/* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–≥—Ä–æ–∫–∏ */}
                        <div className="ctem-available-column">
                            <h4>üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–≥—Ä–æ–∫–∏ ({availablePlayers.length})</h4>
                            <p className="ctem-column-hint">–ò–∑ –≤–∞—à–µ–π –≥–ª–æ–±–∞–ª—å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã "{globalTeam?.name}"</p>
                            
                            {availablePlayers.length === 0 ? (
                                <div className="ctem-empty-message">
                                    –í—Å–µ –∏–≥—Ä–æ–∫–∏ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã —É–∂–µ –≤ —Ç—É—Ä–Ω–∏—Ä–Ω–æ–º —Å–æ—Å—Ç–∞–≤–µ
                                </div>
                            ) : (
                                <div className="ctem-available-players-list">
                                    {availablePlayers.map((player, index) => (
                                        <DraggablePlayer
                                            key={player.user_id}
                                            player={player}
                                            index={index}
                                            onMove={handleMove}
                                            isRosterSlot={false}
                                            canDrag={!loading}
                                        />
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="ctem-modal-footer">
                        <div className="ctem-footer-info">
                            <span>üí° –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–≥—Ä–æ–∫–æ–≤ –º–µ–∂–¥—É —Å–ø–∏—Å–∫–∞–º–∏ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Å—Ç–∞–≤–∞</span>
                        </div>
                        <div className="ctem-footer-actions">
                            <button 
                                className="btn btn-secondary"
                                onClick={onClose}
                                disabled={loading}
                            >
                                –û—Ç–º–µ–Ω–∞
                            </button>
                            <button 
                                className="btn btn-primary"
                                onClick={handleSave}
                                disabled={loading || tournamentRoster.length === 0}
                            >
                                {loading ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–∞–≤'}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </DndProvider>
    );
};

export default CaptainTeamEditModal;

