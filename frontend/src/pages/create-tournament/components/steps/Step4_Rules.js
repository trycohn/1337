// frontend/src/pages/create-tournament/components/steps/Step4_Rules.js
import React, { useState, useEffect } from 'react';
import axios from 'axios';

/**
 * –®–∞–≥ 4: –ü—Ä–∞–≤–∏–ª–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Ç—á–µ–π
 * –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å –≤—ã–±–æ—Ä–æ–º –∫–∞—Ä—Ç CS2
 */
function Step4_Rules({ data, format, basicInfo, onChange }) {
  const [cs2Maps, setCs2Maps] = useState([]);
  const [defaultCs2Maps, setDefaultCs2Maps] = useState([]); // üÜï –ë–∞–∑–æ–≤—ã–π –º–∞–ø–ø—É–ª 5—Ö5
  const [loadingMaps, setLoadingMaps] = useState(false);
  const [mapsInitialized, setMapsInitialized] = useState(false); // üÜï –§–ª–∞–≥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  const [mapMode, setMapMode] = useState('default'); // 'default' | 'wingman'
  const [localFormConfig, setLocalFormConfig] = useState(() => {
    const cfg = (data && data.application_form_config) || {};
    return {
      enabled: !!cfg.enabled,
      fill_mode: cfg.fill_mode || 'all', // all|captain
      min_age: cfg.min_age || '',
      fields: Array.isArray(cfg.fields) ? cfg.fields : []
    };
  });

  const handleChange = (field, value) => {
    onChange({ ...data, [field]: value });
  };

  const isCS2 = basicInfo.game === 'counter strike 2';
  
  // üîç DEBUG: –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è –¥–ª—è –ª–∏—Å—Ç–∞ –æ–∂–∏–¥–∞–Ω–∏—è
  console.log('üîç [Step4_Rules] –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –ª–∏—Å—Ç–∞ –æ–∂–∏–¥–∞–Ω–∏—è:', {
    format: format?.format,
    participant_type: format?.participant_type,
    isSingle: format?.format === 'single',
    isDouble: format?.format === 'double',
    isTeam: format?.participant_type === 'team',
    shouldShow: format && (format.format === 'single' || format.format === 'double') && format.participant_type === 'team'
  });

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç CS2 –∏–∑ –ë–î (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
  useEffect(() => {
    if (!isCS2) return;
    // –ï—Å–ª–∏ —ç—Ç–æ Wingman (2—Ö2), –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –º–∞–ø–ø—É–ª 5—Ö5, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å Wingman
    if (parseInt(format?.team_size, 10) === 2) return;
    if (cs2Maps.length > 0) return; // –£–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã

    const fetchMaps = async () => {
      try {
        setLoadingMaps(true);
        const response = await axios.get('/api/maps?game=Counter-Strike 2');
        // –ï—Å–ª–∏ —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω Wingman —Ä–µ–∂–∏–º, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø—É–ª
        if (mapMode === 'default') {
          setCs2Maps(response.data);
          setDefaultCs2Maps(response.data);
        }
        console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–∞—Ä—Ç CS2:', response.data.length);
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç CS2:', error);
        // Fallback: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—É–ª –∫–∞—Ä—Ç
        const fallbackMaps = [
          { id: 1, name: 'de_mirage', display_name: 'Mirage' },
          { id: 2, name: 'de_inferno', display_name: 'Inferno' },
          { id: 3, name: 'de_nuke', display_name: 'Nuke' },
          { id: 4, name: 'de_overpass', display_name: 'Overpass' },
          { id: 5, name: 'de_vertigo', display_name: 'Vertigo' },
          { id: 6, name: 'de_ancient', display_name: 'Ancient' },
          { id: 7, name: 'de_anubis', display_name: 'Anubis' }
        ];
        if (mapMode === 'default') {
          setCs2Maps(fallbackMaps);
          setDefaultCs2Maps(fallbackMaps);
        }
      } finally {
        setLoadingMaps(false);
      }
    };

    fetchMaps();
  }, [isCS2, cs2Maps.length, mapMode, format?.team_size]);

  // üÜï Wingman –º–∞–ø–ø—É–ª (2—Ö2)
  const wingmanMaps = [
    { id: 1001, name: 'de_inferno', display_name: 'Inferno' },
    { id: 1002, name: 'de_mirage', display_name: 'Mirage' },
    { id: 1003, name: 'de_nuke', display_name: 'Nuke' },
    { id: 1004, name: 'de_overpass', display_name: 'Overpass' },
    { id: 1005, name: 'de_vertigo', display_name: 'Vertigo' },
    { id: 1006, name: 'de_anubis', display_name: 'Anubis' },
    { id: 1007, name: 'de_train', display_name: 'Train' }
  ];

  // üÜï –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–∞–ø–ø—É–ª–∞ –¥–ª—è CS2 –ø—Ä–∏ —Ä–∞–∑–º–µ—Ä–µ —Å–æ—Å—Ç–∞–≤–∞ 2 (Wingman)
  useEffect(() => {
    if (!isCS2) return;
    const isWingman = parseInt(format?.team_size, 10) === 2;
    const wingNames = wingmanMaps.map(m => m.name);
    const currentNames = cs2Maps.map(m => m.name);

    if (isWingman && mapMode !== 'wingman') {
      setCs2Maps(wingmanMaps);
      setMapMode('wingman');
      // –ê–≤—Ç–æ–≤—ã–±–æ—Ä: –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ, –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ ‚Äî –¥–æ–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–º–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–æ 7
      if (data.lobby_enabled) {
        const current = Array.isArray(data.selected_maps) ? data.selected_maps : [];
        const intersection = current.filter(n => wingNames.includes(n));
        const filled = [...intersection];
        for (let i = 0; i < wingNames.length && filled.length < 7; i += 1) {
          if (!filled.includes(wingNames[i])) filled.push(wingNames[i]);
        }
        handleChange('selected_maps', filled.slice(0, 7));
      }
    }

    if (!isWingman && mapMode !== 'default') {
      setCs2Maps(defaultCs2Maps);
      setMapMode('default');
      // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –Ω–µ –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –ø—É–ª–∞ ‚Äî –æ—á–∏—â–∞–µ–º –¥–æ –≤–∞–ª–∏–¥–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –Ω–æ –Ω–µ –Ω–∞–≤—è–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
      if (data.lobby_enabled && defaultCs2Maps.length) {
        const baseNames = defaultCs2Maps.map(m => m.name);
        const current = Array.isArray(data.selected_maps) ? data.selected_maps : [];
        const filtered = current.filter(n => baseNames.includes(n));
        handleChange('selected_maps', filtered);
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isCS2, format?.team_size, data.lobby_enabled, defaultCs2Maps.length]);

  // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –≤—Å–µ—Ö –∫–∞—Ä—Ç –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –ª–æ–±–±–∏ (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
  useEffect(() => {
    if (!data.lobby_enabled) return;
    if (!cs2Maps.length) return;
    if (mapsInitialized) return; // –£–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
    if (data.selected_maps && data.selected_maps.length > 0) return; // –£–∂–µ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–∞—Ä—Ç—ã
    const allMapNames = cs2Maps.map(m => m.name);
    if (allMapNames.length === 7) {
      handleChange('selected_maps', allMapNames);
      setMapsInitialized(true); // üÜï –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
    }
  }, [data.lobby_enabled, cs2Maps.length, mapsInitialized, data.selected_maps]); // –£–±—Ä–∞–ª–∏ handleChange –∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
  const handleMapToggle = (mapName) => {
    const currentMaps = data.selected_maps || [];
    const isSelected = currentMaps.includes(mapName);

    if (isSelected) {
      // –£–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç—É
      handleChange('selected_maps', currentMaps.filter(m => m !== mapName));
    } else {
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
      handleChange('selected_maps', [...currentMaps, mapName]);
    }
  };

  // –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –∫–∞—Ä—Ç—ã
  const handleSelectAllMaps = () => {
    const allMapNames = cs2Maps.map(m => m.name);
    // –î–ª—è Wingman –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–µ 7 –∫–∞—Ä—Ç, —á—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é 7/7
    const target = mapMode === 'wingman' ? allMapNames.slice(0, 7) : allMapNames;
    handleChange('selected_maps', target);
  };

  // –°–Ω—è—Ç—å –≤—ã–±–æ—Ä —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç
  const handleDeselectAllMaps = () => {
    handleChange('selected_maps', []);
  };

  return (
    <div className="wizard-step step-rules">
      <div className="step-header">
        <h2>üìú –ü—Ä–∞–≤–∏–ª–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <p className="step-description">
          –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–∞—Ç—á–µ–π
        </p>
      </div>

      <div className="step-section">
        <h3>–ü—Ä–∞–≤–∏–ª–∞ —Ç—É—Ä–Ω–∏—Ä–∞</h3>
        
        <div className="form-group">
          <label>–ü—Ä–∞–≤–∏–ª–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <textarea
            placeholder="–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ —É—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è..."
            value={data.rules || ''}
            onChange={(e) => handleChange('rules', e.target.value)}
            rows="5"
          />
          <small className="form-hint">
            –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ —Ç—É—Ä–Ω–∏—Ä–∞, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º, —à—Ç—Ä–∞—Ñ—ã –∏ —Ç.–¥.
          </small>
        </div>

        <div className="form-group">
          <label>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤ —Å–µ—Ç–∫–µ (Seeding)</label>
          <select
            value={data.seeding_type || 'random'}
            onChange={(e) => handleChange('seeding_type', e.target.value)}
          >
            <option value="random">–°–ª—É—á–∞–π–Ω–æ–µ</option>
            <option value="rating">–ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É</option>
            <option value="balanced">–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ</option>
          </select>
          <small className="form-hint">
            –≠—Ç–æ –Ω–µ MIX-—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥. Seeding –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞—á–∞–ª—å–Ω—É—é —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫—É –∫–æ–º–∞–Ω–¥ –≤ —Ç—É—Ä–Ω–∏—Ä–Ω–æ–π —Å–µ—Ç–∫–µ.
          </small>
        </div>

        {/* üÜï –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—è–∑–∫–∏ FACEIT –∞–∫–∫–∞—É–Ω—Ç–∞ (–¥–ª—è CS2, –Ω–∞ —à–∞–≥–µ –ü—Ä–∞–≤–∏–ª–∞) */}
        {isCS2 && (
          <div className="form-group">
            <label className="checkbox-label">
              <input
                type="checkbox"
                checked={data.require_faceit_linked || false}
                onChange={(e) => handleChange('require_faceit_linked', e.target.checked)}
              />
              <span>–¢—Ä–µ–±–æ–≤–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É FACEIT –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è —É—á–∞—Å—Ç–∏—è</span>
            </label>
            <small className="form-hint">–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ ‚Äî –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ —Å–º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º FACEIT –∞–∫–∫–∞—É–Ω—Ç–æ–º.</small>
          </div>
        )}

        {/* üÜï –ê–Ω–∫–µ—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞ (–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä) */}
        <div className="form-group" style={{ marginTop: '12px', paddingTop: '12px', borderTop: '1px solid #333' }}>
          <label className="checkbox-label">
            <input
              type="checkbox"
              checked={localFormConfig.enabled}
              onChange={(e) => {
                const next = { ...localFormConfig, enabled: e.target.checked };
                setLocalFormConfig(next);
                onChange({ ...data, application_form_config: next });
              }}
            />
            <span>–¢—Ä–µ–±–æ–≤–∞—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–Ω–∫–µ—Ç—ã –ø—Ä–∏ —É—á–∞—Å—Ç–∏–∏</span>
          </label>

          {localFormConfig.enabled && (
            <div style={{ marginTop: '12px', padding: '12px', background: '#1a1a1a', border: '1px solid #333', borderRadius: '6px', display: 'grid', gap: '12px' }}>
              {/* –†–µ–∂–∏–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è */}
              <div>
                <label>–ö—Ç–æ –∑–∞–ø–æ–ª–Ω—è–µ—Ç</label>
                <select
                  value={localFormConfig.fill_mode}
                  onChange={(e) => {
                    const next = { ...localFormConfig, fill_mode: e.target.value };
                    setLocalFormConfig(next);
                    onChange({ ...data, application_form_config: next });
                  }}
                >
                  <option value="all">–ö–∞–∂–¥—ã–π –∏–≥—Ä–æ–∫</option>
                  <option value="captain">–¢–æ–ª—å–∫–æ –∫–∞–ø–∏—Ç–∞–Ω –∫–æ–º–∞–Ω–¥—ã</option>
                </select>
                <small className="form-hint">–î–ª—è –∫–æ–º–∞–Ω–¥–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–æ–≤ –º–æ–∂–Ω–æ —Ç—Ä–µ–±–æ–≤–∞—Ç—å –∞–Ω–∫–µ—Ç—É —Ç–æ–ª—å–∫–æ –æ—Ç –∫–∞–ø–∏—Ç–∞–Ω–∞</small>
              </div>

              {/* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */}
              <div>
                <label>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input
                  type="number"
                  min="0"
                  max="120"
                  value={localFormConfig.min_age}
                  onChange={(e) => {
                    const v = e.target.value;
                    const next = { ...localFormConfig, min_age: v === '' ? '' : parseInt(v, 10) };
                    setLocalFormConfig(next);
                    onChange({ ...data, application_form_config: next });
                  }}
                  placeholder="–ù–∞–ø—Ä. 16"
                />
                <small className="form-hint">–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ ‚Äî –ø—Ä–æ–≤–µ—Ä–∏–º –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ</small>
              </div>

              {/* –ü–æ–ª—è –∞–Ω–∫–µ—Ç—ã */}
              <div>
                <label>–ü–æ–ª—è –∞–Ω–∫–µ—Ç—ã</label>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(220px, 1fr))', gap: '10px' }}>
                  {[
                    { key: 'last_name', label: '–§–∞–º–∏–ª–∏—è' },
                    { key: 'first_name', label: '–ò–º—è' },
                    { key: 'middle_name', label: '–û—Ç—á–µ—Å—Ç–≤–æ' },
                    { key: 'date_of_birth', label: '–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è' },
                    { key: 'region', label: '–†–µ–≥–∏–æ–Ω –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è' },
                    { key: 'vk_url', label: 'VK' },
                    { key: 'telegram_url', label: 'Telegram' },
                    { key: 'phone', label: '–¢–µ–ª–µ—Ñ–æ–Ω' },
                    { key: 'steam_url', label: 'Steam' },
                    { key: 'faceit_url', label: 'FACEIT' }
                  ].map((f) => {
                    const existing = (localFormConfig.fields || []).find((x) => x.key === f.key) || { key: f.key, required: false };
                    const isChecked = !!(localFormConfig.fields || []).some((x) => x.key === f.key);
                    return (
                      <label key={f.key} className="checkbox-label" style={{ display: 'flex', alignItems: 'center', gap: '8px', background: '#111', border: '1px solid #333', borderRadius: '6px', padding: '8px' }}>
                        <input
                          type="checkbox"
                          checked={isChecked}
                          onChange={(e) => {
                            let nextFields = Array.isArray(localFormConfig.fields) ? [...localFormConfig.fields] : [];
                            if (e.target.checked) {
                              nextFields.push({ key: f.key, required: false });
                            } else {
                              nextFields = nextFields.filter((x) => x.key !== f.key);
                            }
                            const next = { ...localFormConfig, fields: nextFields };
                            setLocalFormConfig(next);
                            onChange({ ...data, application_form_config: next });
                          }}
                        />
                        <span style={{ flex: 1 }}>{f.label}</span>
                        {isChecked && (
                          <label className="checkbox-label" style={{ marginLeft: 'auto' }}>
                            <input
                              type="checkbox"
                              checked={!!existing.required}
                              onChange={(e) => {
                                const nextFields = (localFormConfig.fields || []).map((x) => x.key === f.key ? { ...x, required: e.target.checked } : x);
                                const next = { ...localFormConfig, fields: nextFields };
                                setLocalFormConfig(next);
                                onChange({ ...data, application_form_config: next });
                              }}
                            />
                            <span>–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ</span>
                          </label>
                        )}
                      </label>
                    );
                  })}
                </div>
                <small className="form-hint">–û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–ª—è –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å. –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –º–æ–∂–µ—Ç —Å–æ—á–µ—Ç–∞—Ç—å—Å—è —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –≤–æ–∑—Ä–∞—Å—Ç–æ–º.</small>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–±–±–∏ –¥–ª—è CS2 */}
      {isCS2 && (
        <div className="step-section">
          <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–±–±–∏ CS2</h3>
          
          <div className="form-group">
            <label className="checkbox-label">
              <input
                type="checkbox"
                checked={data.lobby_enabled || false}
                onChange={(e) => handleChange('lobby_enabled', e.target.checked)}
              />
              <span>–í–∫–ª—é—á–∏—Ç—å –ª–æ–±–±–∏ –º–∞—Ç—á–∞ —Å –≤—ã–±–æ—Ä–æ–º –∫–∞—Ä—Ç</span>
            </label>
            <small className="form-hint">
              –£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å–º–æ–≥—É—Ç –≤—ã–±–∏—Ä–∞—Ç—å –∏ –±–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç—ã –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –º–∞—Ç—á–∞
            </small>
          </div>

          {data.lobby_enabled && (
            <>
              <div className="form-group">
                <label>–§–æ—Ä–º–∞—Ç –º–∞—Ç—á–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                <select
                  value={data.lobby_match_format || ''}
                  onChange={(e) => handleChange('lobby_match_format', e.target.value)}
                >
                  <option value="">–í—ã–±–æ—Ä –≤ –ª–æ–±–±–∏</option>
                  <option value="bo1">Best of 1</option>
                  <option value="bo3">Best of 3</option>
                  <option value="bo5">Best of 5</option>
                </select>
                <small className="form-hint">
                  –§–æ—Ä–º–∞—Ç –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º –º–∞—Ç—á–∞–º, –∫—Ä–æ–º–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω –æ—Å–æ–±—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∏–Ω–∞–ª–∞)
                </small>
              </div>

              {/* üÜï –û—Å–æ–±—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Ñ–∏–Ω–∞–ª–∞ */}
              <div className="form-group">
                <label className="checkbox-label">
                  <input
                    type="checkbox"
                    checked={data.enable_final_format || false}
                    onChange={(e) => handleChange('enable_final_format', e.target.checked)}
                  />
                  <span>–û—Å–æ–±—ã–π —Ñ–æ—Ä–º–∞—Ç –º–∞—Ç—á–µ–π —Ñ–∏–Ω–∞–ª–∞</span>
                </label>
                <small className="form-hint">
                  –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –º–∞—Ç—á–µ–π (—Ñ–∏–Ω–∞–ª, –ø–æ–ª—É—Ñ–∏–Ω–∞–ª, –≥—Ä–∞–Ω–¥-—Ñ–∏–Ω–∞–ª)
                </small>
              </div>

              {data.enable_final_format && (
                <div className="form-group" style={{ marginLeft: '30px', paddingLeft: '15px', borderLeft: '2px solid #ff0000' }}>
                  <label>–§–æ—Ä–º–∞—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –º–∞—Ç—á–µ–π</label>
                  <select
                    value={data.final_match_format || 'bo3'}
                    onChange={(e) => handleChange('final_match_format', e.target.value)}
                  >
                    <option value="bo1">Best of 1</option>
                    <option value="bo3">Best of 3</option>
                    <option value="bo5">Best of 5</option>
                  </select>
                  <small className="form-hint">
                    –≠—Ç–æ—Ç —Ñ–æ—Ä–º–∞—Ç –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –∫ —Ñ–∏–Ω–∞–ª—É, –ø–æ–ª—É—Ñ–∏–Ω–∞–ª–∞–º –∏ –≥—Ä–∞–Ω–¥-—Ñ–∏–Ω–∞–ª—É
                  </small>
                </div>
              )}

              {/* –í—ã–±–æ—Ä –∫–∞—Ä—Ç —Ç—É—Ä–Ω–∏—Ä–∞ */}
              <div className="form-group">
                <label>–ö–∞—Ä—Ç—ã —Ç—É—Ä–Ω–∏—Ä–∞ (–≤—ã–±–µ—Ä–∏—Ç–µ 7 –∫–∞—Ä—Ç) *</label>

                {/* üÜï –ò–Ω—Ñ–æ–±–ª–æ–∫ –ø—Ä–æ Wingman */}
                {mapMode === 'wingman' && (
                  <div style={{
                    marginTop: '8px',
                    marginBottom: '8px',
                    padding: '10px 12px',
                    background: 'rgba(0, 128, 255, 0.1)',
                    border: '1px solid rgba(0, 128, 255, 0.3)',
                    borderRadius: '6px',
                    color: '#66b3ff',
                    fontSize: '13px'
                  }} title="–†–∞–∑–º–µ—Ä —Å–æ—Å—Ç–∞–≤–∞ 2 ‚Üí –º–∞–ø–ø—É–ª –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω –Ω–∞ Wingman (2—Ö2)">
                    ‚ÑπÔ∏è –†–∞–∑–º–µ—Ä —Å–æ—Å—Ç–∞–≤–∞ = 2. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –º–∞–ø–ø—É–ª Wingman (2—Ö2). –ö–∞—Ä—Ç—ã –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç 5—Ö5.
                  </div>
                )}
                
                {loadingMaps ? (
                  <div style={{ padding: '20px', textAlign: 'center', color: '#888' }}>
                    –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç...
                  </div>
                ) : (
                  <>
                    {/* –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ */}
                    <div style={{ 
                      display: 'flex', 
                      gap: '10px', 
                      marginBottom: '15px',
                      flexWrap: 'wrap'
                    }}>
                      <button
                        type="button"
                        className="btn btn-secondary"
                        onClick={handleSelectAllMaps}
                        style={{ fontSize: '13px', padding: '6px 12px' }}
                      >
                        ‚úì –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                      </button>
                      <button
                        type="button"
                        className="btn btn-secondary"
                        onClick={handleDeselectAllMaps}
                        style={{ fontSize: '13px', padding: '6px 12px' }}
                      >
                        ‚úó –°–Ω—è—Ç—å –≤—ã–±–æ—Ä
                      </button>
                      <div style={{ 
                        marginLeft: 'auto', 
                        padding: '6px 12px', 
                        background: '#1a1a1a',
                        border: '1px solid #333',
                        borderRadius: '6px',
                        fontSize: '13px',
                        color: (data.selected_maps?.length === 7) ? '#00ff00' : '#888'
                      }}>
                        –í—ã–±—Ä–∞–Ω–æ: {data.selected_maps?.length || 0}/7
                      </div>
                    </div>

                    {/* –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç */}
                    <div className="maps-grid">
                      {cs2Maps.map((map) => {
                        const isSelected = (data.selected_maps || []).includes(map.name);
                        
                        return (
                          <label
                            key={map.id}
                            className={`map-card ${isSelected ? 'selected' : ''}`}
                          >
                            <input
                              type="checkbox"
                              value={map.name}
                              checked={isSelected}
                              onChange={() => handleMapToggle(map.name)}
                            />
                            
                            {/* –ò–∫–æ–Ω–∫–∞ —á–µ–∫–±–æ–∫—Å–∞ */}
                            <div className="map-checkbox-icon">
                              {isSelected && '‚úì'}
                            </div>

                            {/* –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã */}
                            <span className="map-name">
                              {map.display_name || map.name.replace('de_', '').charAt(0).toUpperCase() + map.name.replace('de_', '').slice(1)}
                            </span>
                          </label>
                        );
                      })}
                    </div>

                    {/* –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∫–∞—Ä—Ç */}
                    {data.selected_maps && data.selected_maps.length !== 7 && (
                      <div style={{
                        marginTop: '12px',
                        padding: '10px 12px',
                        background: 'rgba(255, 165, 0, 0.1)',
                        border: '1px solid rgba(255, 165, 0, 0.3)',
                        borderRadius: '6px',
                        color: '#ffa500',
                        fontSize: '13px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                      }}>
                        ‚ö†Ô∏è –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Ä–æ–≤–Ω–æ 7 –∫–∞—Ä—Ç (–≤—ã–±—Ä–∞–Ω–æ: {data.selected_maps.length})
                      </div>
                    )}

                    {data.selected_maps && data.selected_maps.length === 7 && (
                      <div style={{
                        marginTop: '12px',
                        padding: '10px 12px',
                        background: 'rgba(0, 255, 0, 0.1)',
                        border: '1px solid rgba(0, 255, 0, 0.3)',
                        borderRadius: '6px',
                        color: '#00ff00',
                        fontSize: '13px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                      }}>
                        ‚úì –í—ã–±—Ä–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç
                      </div>
                    )}
                  </>
                )}
              </div>
            </>
          )}
        </div>
      )}

      {/* –õ–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è –¥–ª—è –∫–æ–º–∞–Ω–¥–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–æ–≤ Single/Double Elimination */}
      {format && (format.format === 'single' || format.format === 'double') && format.participant_type === 'team' && (
        <div className="step-section">
          <h3>üìã –õ–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è</h3>
          
          <div className="form-group">
            <label className="checkbox-label">
              <input
                type="checkbox"
                checked={format.waiting_list_enabled || false}
                onChange={(e) => onChange({ ...format, waiting_list_enabled: e.target.checked })}
              />
              <span>–í–∫–ª—é—á–∏—Ç—å –ª–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è –¥–ª—è —Å–æ–ª–æ –∏–≥—Ä–æ–∫–æ–≤?</span>
            </label>
            <small className="form-hint">
              üìã –ò–≥—Ä–æ–∫–∏ –±–µ–∑ –∫–æ–º–∞–Ω–¥ —Å–º–æ–≥—É—Ç –∑–∞—è–≤–∏—Ç—å—Å—è –≤ –ª–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è, –ø–æ—Å–ª–µ —á–µ–≥–æ –≤—ã —Å–º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∏—Ö –≤ –∫–æ–º–∞–Ω–¥—ã –≤—Ä—É—á–Ω—É—é
            </small>
          </div>

          {format.waiting_list_enabled && (
            <div style={{ marginTop: '16px', paddingLeft: '30px', paddingTop: '12px', borderLeft: '2px solid #ff0000' }}>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                <label className="checkbox-label">
                  <input
                    type="checkbox"
                    checked={format.waiting_list_require_faceit || false}
                    onChange={(e) => onChange({ ...format, waiting_list_require_faceit: e.target.checked })}
                  />
                  <span>–¢—Ä–µ–±–æ–≤–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É FACEIT –∞–∫–∫–∞—É–Ω—Ç–∞</span>
                </label>
                
                <label className="checkbox-label">
                  <input
                    type="checkbox"
                    checked={format.waiting_list_require_steam || false}
                    onChange={(e) => onChange({ ...format, waiting_list_require_steam: e.target.checked })}
                  />
                  <span>–¢—Ä–µ–±–æ–≤–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É Steam ID</span>
                </label>
                
                <small className="form-hint" style={{ marginTop: '8px', color: '#888' }}>
                  ‚ö†Ô∏è –ò–≥—Ä–æ–∫–∏ –±–µ–∑ —Ç—Ä–µ–±—É–µ–º—ã—Ö –ø—Ä–∏–≤—è–∑–æ–∫ –Ω–µ —Å–º–æ–≥—É—Ç –∑–∞—è–≤–∏—Ç—å—Å—è –≤ –ª–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è
                </small>
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
}

export default Step4_Rules;

