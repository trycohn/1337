// üîß –§–ò–ù–ê–õ–¨–ù–´–ô Socket.IO –∫–ª–∏–µ–Ω—Ç –±–µ–∑ HTTP/2
import { io } from 'socket.io-client';

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è HTTP/1.1 setup
const SOCKET_CONFIG = {
  url: process.env.NODE_ENV === 'production' 
    ? 'https://1337community.com'
    : 'http://localhost:3000',
    
  options: {
    path: '/socket.io/',
    
    // üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: WebSocket –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å –Ω–∞–¥–µ–∂–Ω—ã–º fallback
    transports: ['websocket', 'polling'],
    
    // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π retry –¥–ª—è WebSocket
    tryAllTransports: true,
    forceNew: false,
    upgrade: true,
    
    // –ü—Ä–æ–¥–∞–∫—à–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    timeout: 20000,
    reconnection: true,
    reconnectionDelay: 1000,
    reconnectionDelayMax: 5000,
    maxReconnectionAttempts: 10,
    
    // CORS –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    withCredentials: true,
    autoConnect: false, // üîß –ò–°–ü–†–ê–í–õ–ï–ù–û: –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    
    // üîê –ò–°–ü–†–ê–í–õ–ï–ù–û: –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    auth: {
      token: null // –ë—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–µ—Ä–µ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
    },
    
    // –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    transportOptions: {
      polling: {
        extraHeaders: {
          'X-Requested-With': 'XMLHttpRequest'
          // Authorization –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
        }
      },
      websocket: {
        extraHeaders: {
          'Origin': process.env.NODE_ENV === 'production' ? 'https://1337community.com' : 'http://localhost:3000'
          // Authorization –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
        }
      }
    }
  }
};

// üõ°Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: Fallback Socket –æ–±—ä–µ–∫—Ç –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è undefined –æ—à–∏–±–æ–∫
const createFallbackSocket = () => {
  console.warn('‚ö†Ô∏è [Socket.IO Final] –°–æ–∑–¥–∞–µ–º fallback Socket –æ–±—ä–µ–∫—Ç');
  return {
    connected: false,
    id: null,
    auth: {},
    io: {
      opts: {
        transportOptions: { polling: { extraHeaders: {} }, websocket: { extraHeaders: {} } },
        extraHeaders: {}
      },
      engine: { transport: { name: 'fallback' } },
      on: () => {},
      off: () => {}
    },
    on: (event, callback) => {
      console.warn(`‚ö†Ô∏è [Socket.IO Final] Fallback: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ "${event}"`);
      return this;
    },
    emit: (event, ...args) => {
      console.warn(`‚ö†Ô∏è [Socket.IO Final] Fallback: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º emit "${event}"`);
      return this;
    },
    connect: () => {
      console.warn('‚ö†Ô∏è [Socket.IO Final] Fallback: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º connect()');
      return this;
    },
    disconnect: () => {
      console.warn('‚ö†Ô∏è [Socket.IO Final] Fallback: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º disconnect()');
      return this;
    },
    off: () => {
      console.warn('‚ö†Ô∏è [Socket.IO Final] Fallback: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º off()');
      return this;
    }
  };
};

// üõ°Ô∏è –ó–∞—â–∏—â–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è Socket.IO –∏–Ω—Å—Ç–∞–Ω—Å–∞
const createSocketInstance = () => {
  try {
    console.log('üîß [Socket.IO Final] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è HTTP/1.1 –∫–ª–∏–µ–Ω—Ç–∞...');
    console.log(`üîó [Socket.IO Final] –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫: ${SOCKET_CONFIG.url}`);
    
    const socket = io(SOCKET_CONFIG.url, SOCKET_CONFIG.options);
    
    // üõ°Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
    if (!socket) {
      throw new Error('Socket.IO client initialization failed - socket is null/undefined');
    }
    
    if (typeof socket.on !== 'function') {
      throw new Error('Socket.IO client initialization failed - missing "on" method');
    }
    
    if (typeof socket.emit !== 'function') {
      throw new Error('Socket.IO client initialization failed - missing "emit" method');
    }
    
    // Debug events
    socket.on('connect', () => {
      console.log('‚úÖ [Socket.IO Final] –ü–û–î–ö–õ–Æ–ß–ï–ù–û! Transport:', socket.io?.engine?.transport?.name || 'unknown');
      console.log('üîó [Socket.IO Final] Socket ID:', socket.id);
      console.log('üéâ [Socket.IO Final] WebSocket —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ HTTP/2!');
    });
    
    socket.on('connect_error', (error) => {
      console.error('‚ùå [Socket.IO Final] –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error.message);
      console.log('üîÑ [Socket.IO Final] –ü–æ–ø—ã—Ç–∫–∞ fallback –Ω–∞ polling...');
      console.log('üîç [Socket.IO Final] –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', {
        type: error.type,
        description: error.description,
        context: error.context,
        message: error.message
      });
    });
    
    socket.on('disconnect', (reason) => {
      console.warn('‚ö†Ô∏è [Socket.IO Final] –û—Ç–∫–ª—é—á–µ–Ω–∏–µ:', reason);
      if (reason === 'io server disconnect') {
        console.log('üîÑ [Socket.IO Final] –°–µ—Ä–≤–µ—Ä —Ä–∞–∑–æ—Ä–≤–∞–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...');
        socket.connect();
      }
    });
    
    // Transport events —Å –∑–∞—â–∏—Ç–æ–π
    if (socket.io && socket.io.on) {
      socket.io.on('ping', () => {
        console.log('üèì [Socket.IO Final] Ping –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
      });
    }
    
    if (socket.io && socket.io.engine && socket.io.engine.on) {
      socket.io.engine.on('upgrade', () => {
        console.log('‚¨ÜÔ∏è [Socket.IO Final] –£—Å–ø–µ—à–Ω—ã–π upgrade –Ω–∞ WebSocket!');
      });
      
      socket.io.engine.on('upgradeError', (error) => {
        console.warn('‚ö†Ô∏è [Socket.IO Final] –û—à–∏–±–∫–∞ upgrade, –∏—Å–ø–æ–ª—å–∑—É–µ–º polling:', error.message);
      });
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π
    socket.on('error', (error) => {
      console.error('üö® [Socket.IO Final] –û—à–∏–±–∫–∞ Socket.IO:', error);
    });
    
    socket.on('reconnect', (attemptNumber) => {
      console.log(`üîÑ [Socket.IO Final] –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ (–ø–æ–ø—ã—Ç–∫–∞ ${attemptNumber})`);
    });
    
    socket.on('reconnect_attempt', (attemptNumber) => {
      console.log(`üîÑ [Socket.IO Final] –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${attemptNumber}...`);
    });
    
    socket.on('reconnect_error', (error) => {
      console.error('‚ùå [Socket.IO Final] –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error.message);
    });
    
    socket.on('reconnect_failed', () => {
      console.error('‚ùå [Socket.IO Final] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫');
    });
    
    console.log('‚úÖ [Socket.IO Final] Socket –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');
    return socket;
    
  } catch (error) {
    console.error('‚ùå [Socket.IO Final] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
    console.error('‚ùå [Socket.IO Final] Stack trace:', error.stack);
    console.warn('‚ö†Ô∏è [Socket.IO Final] –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback Socket –æ–±—ä–µ–∫—Ç –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫—Ä–∞—Ö–∞');
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º fallback –æ–±—ä–µ–∫—Ç –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è undefined –æ—à–∏–±–æ–∫
    return createFallbackSocket();
  }
};

// –°–æ–∑–¥–∞–µ–º singleton instance
let socketInstance = null;

export const getSocketInstance = () => {
  if (!socketInstance) {
    socketInstance = createSocketInstance();
  }
  
  // üõ°Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –æ–±—ä–µ–∫—Ç –≤–∞–ª–∏–¥–Ω—ã–π
  if (!socketInstance || typeof socketInstance.on !== 'function') {
    console.error('‚ùå [Socket.IO Final] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: socketInstance –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω');
    console.warn('‚ö†Ô∏è [Socket.IO Final] –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º fallback Socket –æ–±—ä–µ–∫—Ç');
    socketInstance = createFallbackSocket();
  }
  
  return socketInstance; // ‚Üê –í–°–ï–ì–î–ê –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç!
};

// üîê –ò–°–ü–†–ê–í–õ–ï–ù–û: –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–µ–π —Ç–æ–∫–µ–Ω–∞
export const authenticateSocket = (token) => {
  const socket = getSocketInstance();
  
  console.log('üîê [Socket.IO Final] –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —Å —Ç–æ–∫–µ–Ω–æ–º');
  
  if (!token) {
    console.error('‚ùå [Socket.IO Final] –¢–æ–∫–µ–Ω –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω!');
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —É –Ω–∞—Å –≤–∞–ª–∏–¥–Ω—ã–π Socket –æ–±—ä–µ–∫—Ç
  if (!socket || typeof socket.emit !== 'function') {
    console.error('‚ùå [Socket.IO Final] –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π Socket –æ–±—ä–µ–∫—Ç –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
    return;
  }
  
  // üîß –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω –≤ auth –æ–±—ä–µ–∫—Ç
  if (socket.auth) {
    socket.auth.token = token;
  } else {
    socket.auth = { token };
  }
  
  // üîß –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –≤ extraHeaders –¥–ª—è –≤—Å–µ—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–≤ (—Å –∑–∞—â–∏—Ç–æ–π)
  const authHeader = `Bearer ${token}`;
  
  try {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è polling
    if (socket.io && socket.io.opts && socket.io.opts.transportOptions && socket.io.opts.transportOptions.polling) {
      socket.io.opts.transportOptions.polling.extraHeaders.Authorization = authHeader;
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è websocket
    if (socket.io && socket.io.opts && socket.io.opts.transportOptions && socket.io.opts.transportOptions.websocket) {
      socket.io.opts.transportOptions.websocket.extraHeaders.Authorization = authHeader;
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤ –æ–±—â–∏–µ extraHeaders (–¥–ª—è Node.js –æ–∫—Ä—É–∂–µ–Ω–∏—è)
    if (socket.io && socket.io.opts) {
      if (!socket.io.opts.extraHeaders) {
        socket.io.opts.extraHeaders = {};
      }
      socket.io.opts.extraHeaders.Authorization = authHeader;
    }
  } catch (error) {
    console.warn('‚ö†Ô∏è [Socket.IO Final] –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error.message);
  }
  
  // –ï—Å–ª–∏ —Å–æ–∫–µ—Ç –µ—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω, –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
  if (!socket.connected) {
    console.log('üîå [Socket.IO Final] –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π...');
    if (typeof socket.connect === 'function') {
      socket.connect();
    }
  } else {
    // üîß –ò–°–ü–†–ê–í–õ–ï–ù–û: –ù–ï —Ä–∞–∑—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    console.log('üîÑ [Socket.IO Final] –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    if (typeof socket.emit === 'function') {
      socket.emit('authenticate', { token });
    }
  }
};

// –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Ç—É—Ä–Ω–∏—Ä—ã
export const watchTournament = (tournamentId) => {
  const socket = getSocketInstance();
  if (socket && typeof socket.emit === 'function') {
    socket.emit('watch_tournament', tournamentId);
  }
};

export const unwatchTournament = (tournamentId) => {
  const socket = getSocketInstance();
  if (socket && typeof socket.emit === 'function') {
    socket.emit('unwatch_tournament', tournamentId);
  }
};

export default getSocketInstance;
