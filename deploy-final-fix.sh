#!/bin/bash

# üéØ –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è TDZ –æ—à–∏–±–∫–∏
# –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ production —Å–µ—Ä–≤–µ—Ä–µ VDS

set -e  # –ü—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

echo "üöÄ ==================================="
echo "üéØ –§–ò–ù–ê–õ–¨–ù–´–ô –î–ï–ü–õ–û–ô: TDZ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
echo "üöÄ ==================================="

# –ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É –Ω–∞ VDS
PROJECT_PATH="/var/www/1337community.com"
BACKEND_SERVICE="1337-backend"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -d "$PROJECT_PATH" ]; then
    echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $PROJECT_PATH"
    exit 1
fi

echo "üìÅ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞..."
cd "$PROJECT_PATH"

echo "üîÑ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ..."
git stash push -m "–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ TDZ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ $(date)"

echo "üì• –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ GitHub..."
git fetch origin main

echo "üîÑ –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
git reset --hard origin/main

echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å Git..."
git status

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ fix-final-tdz-error.js –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
if [ -f "fix-final-tdz-error.js" ]; then
    echo "‚úÖ –°–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è TDZ –Ω–∞–π–¥–µ–Ω"
    
    echo "üîß –ü—Ä–∏–º–µ–Ω—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è TDZ..."
    node fix-final-tdz-error.js
    
    echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç..."
    rm -f fix-final-tdz-error.js
else
    echo "‚ÑπÔ∏è –°–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏–∑–º–µ–Ω–µ–Ω–∏—è —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä TournamentDetails.js
TOURNAMENT_FILE="frontend/src/components/TournamentDetails.js"
if [ -f "$TOURNAMENT_FILE" ]; then
    FILE_SIZE=$(wc -c < "$TOURNAMENT_FILE")
    echo "üìè –†–∞–∑–º–µ—Ä TournamentDetails.js: $FILE_SIZE –±–∞–π—Ç"
else
    echo "‚ö†Ô∏è –§–∞–π–ª TournamentDetails.js –Ω–µ –Ω–∞–π–¥–µ–Ω!"
fi

echo "üì¶ –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ frontend..."
cd frontend
npm ci --only=production

echo "üèóÔ∏è –°–æ–±–∏—Ä–∞–µ–º production –≤–µ—Ä—Å–∏—é..."
npm run build

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∫–∏
if [ $? -eq 0 ]; then
    echo "‚úÖ Frontend —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –Ω–æ–≤–æ–≥–æ bundle
    MAIN_JS=$(find build/static/js -name "main.*.js" | head -1)
    if [ -f "$MAIN_JS" ]; then
        BUNDLE_SIZE=$(stat -c%s "$MAIN_JS")
        BUNDLE_SIZE_KB=$((BUNDLE_SIZE / 1024))
        echo "üì¶ –†–∞–∑–º–µ—Ä –Ω–æ–≤–æ–≥–æ bundle: ${BUNDLE_SIZE_KB} KB"
        echo "üìÑ –§–∞–π–ª: $(basename "$MAIN_JS")"
    fi
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ frontend!"
    exit 1
fi

echo "üîÑ –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
cd "$PROJECT_PATH"

echo "üì¶ –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ backend..."
cd backend
npm ci --only=production

echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backend —Å–µ—Ä–≤–∏—Å..."
cd "$PROJECT_PATH"
sudo systemctl restart "$BACKEND_SERVICE"

echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ backend (10 —Å–µ–∫—É–Ω–¥)..."
sleep 10

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å backend —Å–µ—Ä–≤–∏—Å–∞..."
if sudo systemctl is-active --quiet "$BACKEND_SERVICE"; then
    echo "‚úÖ Backend —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–ø—É—Å–∫–æ–º backend —Å–µ—Ä–≤–∏—Å–∞"
    echo "üìã –õ–æ–≥–∏ backend:"
    sudo journalctl -u "$BACKEND_SERVICE" --no-pager -n 20
    exit 1
fi

echo "üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
rm -f fix-final-tdz-error.js
rm -f deploy-final-fix.sh

echo ""
echo "üéâ ================================="
echo "‚úÖ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!"
echo "üéâ ================================="
echo ""
echo "üìà –†–µ–∑—É–ª—å—Ç–∞—Ç:"
echo "   ‚úÖ TDZ –æ—à–∏–±–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã"
echo "   ‚úÖ Frontend –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏"
echo "   ‚úÖ Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
echo "   ‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç"
echo ""
echo "üîç –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:"
echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å DevTools (F12)"
echo "   3. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç—É—Ä–Ω–∏—Ä–∞"
echo "   4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç –æ—à–∏–±–æ–∫ TDZ"
echo ""
echo "üìÑ –õ–æ–≥–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:"
echo "   sudo journalctl -u $BACKEND_SERVICE -f"
echo ""
echo "üéØ TDZ –æ—à–∏–±–∫–∏ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!" 