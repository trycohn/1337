# 📊 СТАТИСТИКА ФИДБЕКОВ - ПОЛНОЕ РУКОВОДСТВО

**Дата:** 2 октября 2025  
**Версия:** 1.0  
**Статус:** Архитектура готова, UI частично

---

## 🎯 КАК СОБИРАЕТСЯ СТАТИСТИКА

### Автоматический процесс:

```
1. Игрок отправляет feedback
   ↓
2. Сохранение в match_feedback
   ├─ reviewer_id → кто оценил
   ├─ reviewed_id → кого оценили
   ├─ fairness_rating → оценка честности
   ├─ behavior_rating → оценка поведения
   └─ teamplay_rating → оценка командности
   ↓
3. Вызов функции update_player_reputation(reviewed_id)
   ↓
4. PostgreSQL функция:
   ├─ Считает все feedbacks для игрока
   ├─ Подсчитывает: clean, suspicious, cheating reports
   ├─ Вычисляет scores (fairness, behavior, teamplay)
   ├─ Рассчитывает Reputation Index (0-100)
   └─ Сохраняет в player_reputation
   ↓
5. Данные доступны через API и БД
```

### Таблицы статистики:

```sql
match_feedback (исходные данные)
├─ Каждая строка = одна оценка
├─ Связь: reviewer → reviewed
└─ Фильтры: по матчу, турниру, игроку, дате

player_reputation (агрегация)
├─ Одна строка = один игрок
├─ Автоматически обновляется
└─ Готовая статистика

coin_transactions (история наград)
├─ Каждая строка = одна транзакция
└─ Отслеживание кто сколько заработал
```

---

## 👥 КТО МОЖЕТ ПРОСМАТРИВАТЬ (по ролям)

### 1️⃣ ОБЫЧНЫЕ ИГРОКИ

**Что могут видеть:**

✅ **Свою репутацию (полная):**
- Reputation Index (0-100)
- Fairness Score, Behavior Score, Teamplay Score
- Количество оценок
- Breakdown по категориям

✅ **Репутацию других игроков (публично):**
- Только Reputation Index (общий показатель)
- Количество оценок
- Badge (✅ Отличная / 🟡 Средняя / 🔴 Низкая)

❌ **НЕ могут видеть:**
- Кто именно их оценил
- Детальные оценки других игроков
- Raw feedbacks

### 2️⃣ КАПИТАНЫ КОМАНД

**Дополнительно к обычным игрокам:**

✅ **Репутацию тиммейтов (детально):**
- Полная статистика
- История оценок
- Для принятия решений о составе

✅ **Репутацию соперников (базово):**
- В лобби перед матчем
- Предупреждения о проблемных игроках

### 3️⃣ АДМИНИСТРАТОРЫ

**Полный доступ ко всем данным:**

✅ **Статистика платформы:**
- Total feedbacks за период
- Completion rate
- Топ-10 лучших/худших по репутации
- Динамика по дням/неделям

✅ **Suspicious Reports:**
- Игроки с 3+ cheating reports
- Игроки с низкой репутацией (<30)
- История репортов
- Кто репортил кого

✅ **Individual Player Stats:**
- Полная история всех feedbacks
- Кто оценил, когда, как
- Raw данные для расследований

✅ **Abuse Detection:**
- Игроки которые массово репортят всех
- Revenge reports (взаимные)
- Паттерны накруток

---

## 📍 ГДЕ ПРОСМАТРИВАТЬ СТАТИСТИКУ

### Сейчас доступно:

#### 1. Через SQL (для админов на VDS):

```sql
-- Топ-10 по репутации
SELECT 
    u.username,
    pr.reputation_index,
    pr.total_feedbacks,
    pr.cheating_reports
FROM player_reputation pr
JOIN users u ON u.id = pr.user_id
ORDER BY pr.reputation_index DESC
LIMIT 10;

-- Подозрительные игроки
SELECT 
    u.username,
    pr.reputation_index,
    pr.cheating_reports,
    pr.suspicious_reports,
    pr.total_feedbacks
FROM player_reputation pr
JOIN users u ON u.id = pr.user_id
WHERE pr.cheating_reports >= 3
   OR pr.reputation_index < 30
ORDER BY pr.cheating_reports DESC, pr.reputation_index ASC;

-- Статистика за сегодня
SELECT 
    COUNT(*) as feedbacks_today,
    COUNT(DISTINCT reviewer_id) as active_reviewers,
    COUNT(CASE WHEN fairness_rating = 'cheating' THEN 1 END) as cheating_reports_today
FROM match_feedback
WHERE created_at > CURRENT_DATE;
```

#### 2. Через API (для разработчиков):

```bash
# Репутация игрока
curl "https://1337community.com/api/matches/users/123/reputation" | jq

# В профиле (если добавить endpoint)
curl -H "Authorization: Bearer $TOKEN" \
     "https://1337community.com/api/users/me" | jq
```

### ❌ Чего НЕТ (но нужно):

#### UI для игроков:
- ❌ Вкладка "Репутация" в профиле
- ❌ Badge в списке игроков
- ❌ Показ в лобби/сетке турнира

#### UI для админов:
- ❌ Вкладка "Feedbacks" в админ-панели
- ❌ Дашборд со статистикой
- ❌ Список suspicious reports

---

## 💡 ЧТО НУЖНО ДОБАВИТЬ (Рекомендации)

### Вариант A: Минимальный (1-2 часа)

**Только самое необходимое:**

**1. В профиле игрока (публично):**
```jsx
// frontend/src/components/Profile.js или UserProfile.js

<div className="profile-reputation">
  <h3>Репутация</h3>
  <div className="reputation-score">
    <div className="score-circle">
      {reputation.reputation_index}/100
    </div>
    <span className="score-badge">
      {reputation.reputation_index >= 80 ? '✅ Отличная' : 
       reputation.reputation_index >= 60 ? '🟡 Хорошая' : 
       reputation.reputation_index >= 40 ? '🟠 Средняя' : 
       '🔴 Низкая'}
    </span>
  </div>
  <p>На основе {reputation.total_feedbacks} оценок</p>
</div>
```

**2. В админ-панели (вкладка "Suspicious Reports"):**
```jsx
// frontend/src/components/AdminPanel.js

{activeTab === 'suspiciousReports' && (
  <div>
    <h2>🚨 Подозрительные игроки</h2>
    
    <table>
      <thead>
        <tr>
          <th>Игрок</th>
          <th>Репутация</th>
          <th>Жалоб на чит</th>
          <th>Оценок всего</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        {suspiciousPlayers.map(player => (
          <tr key={player.user_id}>
            <td>{player.username}</td>
            <td>{player.reputation_index}/100</td>
            <td className="danger">{player.cheating_reports}</td>
            <td>{player.total_feedbacks}</td>
            <td>
              <button onClick={() => viewDetails(player.user_id)}>
                🔍 Детали
              </button>
              <button onClick={() => banUser(player.user_id)}>
                🚫 Бан
              </button>
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>
)}
```

**Инвестиции:** 1-2 часа работы  
**Когда:** Можно сделать сразу после деплоя

---

### Вариант B: Полноценный (4-6 часов)

**Все что нужно для production:**

**1. Профиль игрока (детально):**

```
┌──────────────────────────────────────────────┐
│  👤 PlayerName                               │
│  Trust Score: 85/100 ✅                      │
├──────────────────────────────────────────────┤
│  📊 РЕПУТАЦИЯ                                │
│  ┌────────────────────────────────────────┐  │
│  │                                        │  │
│  │         Reputation Index               │  │
│  │                                        │  │
│  │            87/100 ✅                   │  │
│  │     ████████████████████░░             │  │
│  │                                        │  │
│  │  "Доверенный игрок"                   │  │
│  │  На основе 45 оценок                  │  │
│  └────────────────────────────────────────┘  │
│                                               │
│  Детальная статистика:                       │
│  ┌────────────────────┬───────────────────┐  │
│  │ Честность игры     │ 92/100 ✅        │  │
│  │ • Чисто: 40        │ ████████████████ │  │
│  │ • Норм: 4          │ ██               │  │
│  │ • Подозр.: 1       │ ░                │  │
│  │ • Чит: 0           │                  │  │
│  ├────────────────────┼───────────────────┤  │
│  │ Поведение          │ 85/100 ✅        │  │
│  │ • Хорошо: 35       │ ██████████████   │  │
│  │ • Норм: 9          │ ███              │  │
│  │ • Токсично: 1      │ ░                │  │
│  ├────────────────────┼───────────────────┤  │
│  │ Командная игра     │ 81/100 ✅        │  │
│  │ • Отлично: 30      │ ████████████     │  │
│  │ • Норм: 13         │ █████            │  │
│  │ • Плохо: 2         │ ░                │  │
│  └────────────────────┴───────────────────┘  │
│                                               │
│  📈 Динамика репутации:                      │
│  [График последних 30 дней]                  │
└──────────────────────────────────────────────┘
```

**2. Админ-панель (полная вкладка):**

```
┌──────────────────────────────────────────────┐
│  🎮 MATCH FEEDBACKS                          │
├──────────────────────────────────────────────┤
│                                               │
│  📊 СТАТИСТИКА ПЛАТФОРМЫ                     │
│  ┌────────┬────────┬────────┬────────────┐  │
│  │ Всего  │ Сегодня│Completion│ Средняя   │  │
│  │feedback│        │   Rate  │ репутация │  │
│  │  1,247 │   45   │   42%   │   73/100  │  │
│  └────────┴────────┴────────┴────────────┘  │
│                                               │
│  🚨 ПОДОЗРИТЕЛЬНЫЕ ИГРОКИ                    │
│  [Фильтр: 3+ жалоб ▼] [Сортировка ▼]        │
│  ┌───┬──────────┬──────┬──────┬──────────┐  │
│  │ID │Игрок     │Reputation│Жалоб│Действия│  │
│  ├───┼──────────┼──────┼──────┼──────────┤  │
│  │456│Cheater666│  35  │  5   │🔍 🚫 ✅ │  │
│  │789│Suspect123│  42  │  3   │🔍 🚫 ✅ │  │
│  └───┴──────────┴──────┴──────┴──────────┘  │
│                                               │
│  📈 АНАЛИТИКА                                │
│  • Топ-10 честных игроков                    │
│  • Топ-10 проблемных игроков                 │
│  • Статистика по турнирам                    │
│  • Динамика за месяц                         │
└──────────────────────────────────────────────┘
```

**3. В турнире (для организатора):**

```
┌──────────────────────────────────────────────┐
│  🏆 CS2 Weekly Cup #42                       │
│  [Главная] [Сетка] [Участники] [📊 Фидбеки]│
├──────────────────────────────────────────────┤
│  📊 Статистика турнира:                      │
│  • Матчей завершено: 15                      │
│  • Feedbacks получено: 67 из 150 (45%)       │
│  • Жалоб на читинг: 2                        │
│  • Токсичных инцидентов: 3                   │
│                                               │
│  🚨 Требуют внимания:                        │
│  • PlayerX (3 жалобы на чит)                 │
│  • PlayerY (5 жалоб на токсичность)          │
└──────────────────────────────────────────────┘
```

**Инвестиции:** 4-6 часов работы  
**Когда:** После деплоя и первых данных

---

## 📊 ГДЕ ПРОСМАТРИВАТЬ (детально)

### 🎯 ВАРИАНТ 1: ДЛЯ ИГРОКОВ (Своя репутация)

**Где:** В профиле пользователя `/profile`

**Что показывать:**

```javascript
// Добавить в Profile.js новую вкладку

const ProfileReputation = ({ userId }) => {
  const [reputation, setReputation] = useState(null);
  
  useEffect(() => {
    loadReputation();
  }, [userId]);
  
  const loadReputation = async () => {
    const response = await api.get(`/api/matches/users/${userId}/reputation`);
    setReputation(response.data.reputation);
  };
  
  if (!reputation) return <div>Загрузка...</div>;
  
  if (reputation.total_feedbacks === 0) {
    return (
      <div className="reputation-empty">
        <p>У вас пока нет оценок от других игроков</p>
        <p>Участвуйте в турнирах чтобы получить репутацию!</p>
      </div>
    );
  }
  
  return (
    <div className="profile-reputation-tab">
      {/* Главный показатель */}
      <div className="reputation-main">
        <div className="reputation-circle">
          <svg viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="45" fill="none" stroke="#333" strokeWidth="8" />
            <circle 
              cx="50" cy="50" r="45" 
              fill="none" 
              stroke={getReputationColor(reputation.reputation_index)}
              strokeWidth="8"
              strokeDasharray={`${reputation.reputation_index * 2.83} 283`}
              transform="rotate(-90 50 50)"
            />
          </svg>
          <div className="reputation-value">
            {reputation.reputation_index}
          </div>
        </div>
        <div className="reputation-label">
          {getReputationBadge(reputation.reputation_index)}
        </div>
        <div className="reputation-count">
          На основе {reputation.total_feedbacks} оценок
        </div>
      </div>
      
      {/* Детальная разбивка */}
      <div className="reputation-breakdown">
        <h3>Детальная статистика:</h3>
        
        {/* Честность */}
        <div className="reputation-metric">
          <div className="metric-header">
            <span>Честность игры</span>
            <strong>{reputation.fairness_score.toFixed(0)}/100</strong>
          </div>
          <div className="metric-bar">
            <div 
              className="metric-fill fairness"
              style={{width: `${reputation.fairness_score}%`}}
            />
          </div>
          <div className="metric-details">
            <span>😊 Чисто: {reputation.clean_reports}</span>
            <span>😐 Норм: {reputation.normal_reports}</span>
            <span>⚠️ Подозр.: {reputation.suspicious_reports}</span>
            <span className="danger">☠️ Чит: {reputation.cheating_reports}</span>
          </div>
        </div>
        
        {/* Поведение */}
        <div className="reputation-metric">
          <div className="metric-header">
            <span>Поведение</span>
            <strong>{reputation.behavior_score.toFixed(0)}/100</strong>
          </div>
          <div className="metric-bar">
            <div 
              className="metric-fill behavior"
              style={{width: `${reputation.behavior_score}%`}}
            />
          </div>
          <div className="metric-details">
            <span>👍 Хорошо: {reputation.good_behavior}</span>
            <span>😐 Норм: {reputation.normal_behavior}</span>
            <span className="danger">👎 Токсично: {reputation.toxic_behavior}</span>
          </div>
        </div>
        
        {/* Командность */}
        <div className="reputation-metric">
          <div className="metric-header">
            <span>Командная игра</span>
            <strong>{reputation.teamplay_score.toFixed(0)}/100</strong>
          </div>
          <div className="metric-bar">
            <div 
              className="metric-fill teamplay"
              style={{width: `${reputation.teamplay_score}%`}}
            />
          </div>
          <div className="metric-details">
            <span>👍 Отлично: {reputation.excellent_teamplay}</span>
            <span>😐 Норм: {reputation.normal_teamplay}</span>
            <span className="danger">👎 Плохо: {reputation.poor_teamplay}</span>
          </div>
        </div>
      </div>
      
      {/* Предупреждения */}
      {reputation.cheating_reports > 0 && (
        <div className="reputation-warning">
          ⚠️ У вас есть {reputation.cheating_reports} жалоб на читинг.
          Ваш аккаунт может быть проверен модераторами.
        </div>
      )}
    </div>
  );
};

function getReputationColor(score) {
  if (score >= 80) return '#00aa00';
  if (score >= 60) return '#88cc00';
  if (score >= 40) return '#ffaa00';
  return '#ff0000';
}

function getReputationBadge(score) {
  if (score >= 80) return '✅ Отличная репутация';
  if (score >= 60) return '🟢 Хорошая репутация';
  if (score >= 40) return '🟡 Средняя репутация';
  return '🔴 Низкая репутация';
}
```

---

### 🎯 ВАРИАНТ 2: ДЛЯ АДМИНОВ (Suspicious Reports)

**Где:** Админ-панель, новая вкладка

**Backend endpoint (нужно добавить):**

```javascript
// backend/routes/admin.js

/**
 * GET /api/admin/suspicious-players
 * Получить список подозрительных игроков
 */
router.get('/suspicious-players', authenticateToken, requireAdmin, async (req, res) => {
    try {
        const { 
            min_cheating_reports = 3,
            max_reputation = 40,
            limit = 50,
            offset = 0
        } = req.query;
        
        const result = await pool.query(`
            SELECT 
                pr.*,
                u.username,
                u.email,
                u.steam_id,
                u.is_banned,
                uts.trust_score
            FROM player_reputation pr
            JOIN users u ON u.id = pr.user_id
            LEFT JOIN user_trust_scores uts ON uts.user_id = pr.user_id
            WHERE pr.cheating_reports >= $1
               OR pr.reputation_index <= $2
            ORDER BY pr.cheating_reports DESC, pr.reputation_index ASC
            LIMIT $3 OFFSET $4
        `, [min_cheating_reports, max_reputation, limit, offset]);
        
        // Получить детальные feedbacks для каждого
        const playersWithDetails = await Promise.all(
            result.rows.map(async (player) => {
                const feedbacksResult = await pool.query(`
                    SELECT 
                        mf.*,
                        u.username as reviewer_name,
                        m.id as match_id,
                        t.name as tournament_name
                    FROM match_feedback mf
                    JOIN users u ON u.id = mf.reviewer_id
                    JOIN matches m ON m.id = mf.match_id
                    JOIN tournaments t ON t.id = mf.tournament_id
                    WHERE mf.reviewed_id = $1
                      AND mf.fairness_rating IN ('suspicious', 'cheating')
                    ORDER BY mf.created_at DESC
                    LIMIT 10
                `, [player.user_id]);
                
                return {
                    ...player,
                    recent_reports: feedbacksResult.rows
                };
            })
        );
        
        res.json({
            success: true,
            players: playersWithDetails,
            total: result.rows.length
        });
        
    } catch (error) {
        console.error('❌ Ошибка получения suspicious players:', error);
        res.status(500).json({ success: false, error: 'Failed to fetch' });
    }
});

/**
 * GET /api/admin/feedback-stats
 * Общая статистика по feedbacks
 */
router.get('/feedback-stats', authenticateToken, requireAdmin, async (req, res) => {
    try {
        const stats = await pool.query(`
            SELECT 
                COUNT(*) as total_feedbacks,
                COUNT(DISTINCT reviewer_id) as active_reviewers,
                COUNT(DISTINCT reviewed_id) as players_reviewed,
                COUNT(CASE WHEN fairness_rating = 'cheating' THEN 1 END) as cheating_reports,
                COUNT(CASE WHEN fairness_rating = 'suspicious' THEN 1 END) as suspicious_reports,
                COUNT(CASE WHEN behavior_rating = 'toxic' THEN 1 END) as toxic_reports,
                COUNT(CASE WHEN created_at > CURRENT_DATE THEN 1 END) as today_feedbacks,
                AVG(coins_rewarded)::INTEGER as avg_coins_per_feedback
            FROM match_feedback
        `);
        
        const coinsStats = await pool.query(`
            SELECT 
                SUM(balance) as total_coins_in_circulation,
                SUM(lifetime_earned) as total_coins_earned,
                AVG(balance)::INTEGER as avg_balance_per_user
            FROM user_coins
        `);
        
        const reputationStats = await pool.query(`
            SELECT 
                COUNT(*) as players_with_reputation,
                AVG(reputation_index)::INTEGER as avg_reputation,
                COUNT(CASE WHEN reputation_index >= 80 THEN 1 END) as excellent,
                COUNT(CASE WHEN reputation_index < 40 THEN 1 END) as low,
                COUNT(CASE WHEN cheating_reports >= 3 THEN 1 END) as flagged_for_cheating
            FROM player_reputation
        `);
        
        const completionRate = await pool.query(`
            SELECT 
                COUNT(*) as total_prompts,
                COUNT(CASE WHEN feedback_given THEN 1 END) as completed,
                ROUND(100.0 * COUNT(CASE WHEN feedback_given THEN 1 END) / COUNT(*), 2) as completion_rate
            FROM match_feedback_pending
        `);
        
        res.json({
            success: true,
            feedback_stats: stats.rows[0],
            coins_stats: coinsStats.rows[0],
            reputation_stats: reputationStats.rows[0],
            completion_stats: completionRate.rows[0]
        });
        
    } catch (error) {
        console.error('❌ Ошибка получения статистики feedbacks:', error);
        res.status(500).json({ success: false, error: 'Failed to fetch stats' });
    }
});
```

**Frontend (AdminPanel.js):**

```javascript
// Добавить вкладку "🎮 Feedbacks" рядом с Trust Scores

{activeTab === 'feedbacks' && (
  <div className="feedbacks-tab">
    <h2>🎮 Match Feedbacks & Reputation</h2>
    
    {/* Статистика */}
    <div className="feedback-stats-grid">
      <div className="stat-card">
        <div className="stat-value">{feedbackStats.total_feedbacks}</div>
        <div className="stat-label">Всего оценок</div>
      </div>
      <div className="stat-card">
        <div className="stat-value">{feedbackStats.completion_rate}%</div>
        <div className="stat-label">Completion Rate</div>
      </div>
      <div className="stat-card stat-danger">
        <div className="stat-value">{feedbackStats.cheating_reports}</div>
        <div className="stat-label">Жалоб на читинг</div>
      </div>
      <div className="stat-card">
        <div className="stat-value">{feedbackStats.avg_reputation}</div>
        <div className="stat-label">Средняя репутация</div>
      </div>
    </div>
    
    {/* Подозрительные игроки */}
    <h3>🚨 Подозрительные игроки</h3>
    <table className="admin-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Игрок</th>
          <th>Репутация</th>
          <th>Trust Score</th>
          <th>Жалоб на чит</th>
          <th>Всего оценок</th>
          <th>Статус</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        {suspiciousPlayers.map(player => (
          <tr key={player.user_id} className={player.cheating_reports >= 5 ? 'critical-row' : ''}>
            <td>{player.user_id}</td>
            <td>
              <strong>{player.username}</strong>
              <br/>
              <span className="email-small">{player.email}</span>
            </td>
            <td>
              <span className={`reputation-badge rep-${Math.floor(player.reputation_index / 20)}`}>
                {player.reputation_index}/100
              </span>
            </td>
            <td>
              {player.trust_score ? 
                <span className="trust-badge">{player.trust_score}/100</span> : 
                '-'
              }
            </td>
            <td className="danger-text">
              {player.cheating_reports}
            </td>
            <td>{player.total_feedbacks}</td>
            <td>
              {player.is_banned ? 
                <span className="status-banned">❌ Banned</span> :
                <span className="status-active">✅ Active</span>
              }
            </td>
            <td>
              <button onClick={() => viewPlayerDetails(player.user_id)}>
                🔍 Детали
              </button>
              {!player.is_banned && (
                <button onClick={() => banPlayer(player.user_id)}>
                  🚫 Бан
                </button>
              )}
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>
)}
```

---

### 🎯 ВАРИАНТ 3: ПУБЛИЧНОЕ ОТОБРАЖЕНИЕ

**1. Badge в профиле (для всех):**

```jsx
// Где угодно где показывается игрок

<div className="player-card">
  <img src={player.avatar} alt={player.username} />
  <span>{player.username}</span>
  
  {/* 🆕 Reputation Badge */}
  {player.reputation_index && (
    <span className={`reputation-badge rep-${Math.floor(player.reputation_index / 20)}`}>
      {player.reputation_index >= 80 ? '✅' : 
       player.reputation_index >= 60 ? '🟢' : 
       player.reputation_index >= 40 ? '🟡' : '🔴'}
      {player.reputation_index}
    </span>
  )}
</div>
```

**2. В списке участников турнира:**

```
👥 Участники турнира

Team Alpha:
├─ Player1 (Trust: 90 | Rep: 87 ✅)
├─ Player2 (Trust: 75 | Rep: 92 ✅)
├─ Player3 (Trust: 45 | Rep: 35 🔴) ⚠️ Низкая репутация
└─ ...

⚠️ Предупреждение: У Player3 низкая репутация (35/100)
   • Жалоб на читинг: 4
   • Рекомендуем проверку модераторами
```

**3. В лобби матча (для капитанов):**

```
Ожидание игроков...

Team Alpha (ваша команда):
✅ Player1 (Rep: 87)
✅ Player2 (Rep: 92)
⚠️ Player3 (Rep: 35) - Низкая репутация, 4 жалобы на чит

Team Bravo (соперники):
✅ Enemy1 (Rep: 78)
✅ Enemy2 (Rep: 85)
✅ Enemy3 (Rep: 91)

[Начать игру] [Сообщить о проблеме]
```

---

## 📈 SQL ЗАПРОСЫ ДЛЯ АНАЛИТИКИ

### Копируйте и используйте:

```sql
-- ============================================================================
-- 1. ОБЩАЯ СТАТИСТИКА ПЛАТФОРМЫ
-- ============================================================================

SELECT 
    (SELECT COUNT(*) FROM match_feedback) as total_feedbacks,
    (SELECT COUNT(DISTINCT reviewer_id) FROM match_feedback) as active_reviewers,
    (SELECT COUNT(*) FROM player_reputation) as players_with_reputation,
    (SELECT AVG(reputation_index)::INTEGER FROM player_reputation) as avg_reputation,
    (SELECT COUNT(*) FROM player_reputation WHERE cheating_reports >= 3) as flagged_players,
    (SELECT SUM(balance) FROM user_coins) as total_coins;

-- ============================================================================
-- 2. ТОП-20 ЛУЧШИХ ИГРОКОВ
-- ============================================================================

SELECT 
    u.username,
    pr.reputation_index,
    pr.total_feedbacks,
    pr.fairness_score,
    pr.behavior_score,
    pr.cheating_reports
FROM player_reputation pr
JOIN users u ON u.id = pr.user_id
WHERE pr.total_feedbacks >= 10  -- Минимум 10 оценок
ORDER BY pr.reputation_index DESC
LIMIT 20;

-- ============================================================================
-- 3. ПОДОЗРИТЕЛЬНЫЕ ИГРОКИ (3+ жалоб на чит)
-- ============================================================================

SELECT 
    u.id,
    u.username,
    u.email,
    pr.reputation_index,
    pr.cheating_reports,
    pr.suspicious_reports,
    pr.total_feedbacks,
    u.is_banned,
    uts.trust_score
FROM player_reputation pr
JOIN users u ON u.id = pr.user_id
LEFT JOIN user_trust_scores uts ON uts.user_id = pr.user_id
WHERE pr.cheating_reports >= 3
ORDER BY pr.cheating_reports DESC, pr.reputation_index ASC;

-- ============================================================================
-- 4. ДЕТАЛИ ПО КОНКРЕТНОМУ ИГРОКУ
-- ============================================================================

-- Замените 123 на нужный user_id
SELECT 
    mf.id,
    u.username as reviewer,
    mf.fairness_rating,
    mf.behavior_rating,
    mf.teamplay_rating,
    t.name as tournament,
    mf.created_at
FROM match_feedback mf
JOIN users u ON u.id = mf.reviewer_id
JOIN tournaments t ON t.id = mf.tournament_id
WHERE mf.reviewed_id = 123
ORDER BY mf.created_at DESC;

-- ============================================================================
-- 5. COMPLETION RATE (эффективность системы)
-- ============================================================================

SELECT 
    COUNT(*) as total_prompted,
    COUNT(CASE WHEN feedback_given THEN 1 END) as completed,
    ROUND(100.0 * COUNT(CASE WHEN feedback_given THEN 1 END) / COUNT(*), 2) as completion_rate_percent
FROM match_feedback_pending;

-- ============================================================================
-- 6. СТАТИСТИКА ПО ТУРНИРУ
-- ============================================================================

-- Замените 42 на ID турнира
SELECT 
    t.name as tournament_name,
    COUNT(DISTINCT mf.reviewer_id) as reviewers,
    COUNT(mf.id) as total_feedbacks,
    COUNT(CASE WHEN mf.fairness_rating = 'cheating' THEN 1 END) as cheating_reports,
    COUNT(CASE WHEN mf.behavior_rating = 'toxic' THEN 1 END) as toxic_reports
FROM tournaments t
LEFT JOIN match_feedback mf ON mf.tournament_id = t.id
WHERE t.id = 42
GROUP BY t.id, t.name;

-- ============================================================================
-- 7. ДИНАМИКА ЗА ПОСЛЕДНИЕ 7 ДНЕЙ
-- ============================================================================

SELECT 
    DATE(created_at) as date,
    COUNT(*) as feedbacks,
    COUNT(DISTINCT reviewer_id) as reviewers,
    COUNT(CASE WHEN fairness_rating = 'cheating' THEN 1 END) as cheating_reports
FROM match_feedback
WHERE created_at > (CURRENT_DATE - INTERVAL '7 days')
GROUP BY DATE(created_at)
ORDER BY date DESC;

-- ============================================================================
-- 8. ABUSE DETECTION (кто репортит всех)
-- ============================================================================

SELECT 
    u.username,
    COUNT(*) as total_reports,
    COUNT(CASE WHEN mf.fairness_rating = 'cheating' THEN 1 END) as cheating_reports,
    ROUND(100.0 * COUNT(CASE WHEN mf.fairness_rating = 'cheating' THEN 1 END) / COUNT(*), 2) as cheating_rate
FROM match_feedback mf
JOIN users u ON u.id = mf.reviewer_id
GROUP BY u.id, u.username
HAVING COUNT(*) >= 10
   AND ROUND(100.0 * COUNT(CASE WHEN mf.fairness_rating = 'cheating' THEN 1 END) / COUNT(*), 2) > 80
ORDER BY cheating_rate DESC;
```

---

## 🎨 КУДА ДОБАВИТЬ UI (Рекомендации)

### Приоритет 1: Профиль игрока

**Файл:** `frontend/src/components/Profile.js`  
**Вкладка:** Новая "Репутация" (после "Турниры")  
**Компонент:** ProfileReputation (создать)  
**Время:** 1-2 часа

### Приоритет 2: Админ-панель

**Файл:** `frontend/src/components/AdminPanel.js`  
**Вкладка:** "🎮 Feedbacks" (после "Trust Scores")  
**Компоненты:**
- FeedbackStats (статистика)
- SuspiciousPlayers (таблица)
- PlayerFeedbackDetails (модалка с деталями)

**Время:** 2-3 часа

### Приоритет 3: Публичное отображение

**Файлы:** 
- `TournamentParticipants.js` — badge рядом с именем
- `MatchDetailsPage.js` — в составах команд
- `UserProfile.js` — в публичном профиле

**Время:** 1 час

---

## 💡 ХОТИТЕ ЧТОБЫ Я РЕАЛИЗОВАЛ UI?

**Могу сделать сейчас (выберите):**

**A) Минимальный UI (1 час):**
- Вкладка "Репутация" в профиле
- Badge в списках игроков
- Базовая статистика

**B) Полный UI для админов (2-3 часа):**
- Вкладка "Feedbacks" в админ-панели
- Suspicious Players таблица
- Детальная статистика
- Экспорт данных

**C) Оба варианта (3-4 часа)**

**D) Пока не нужно**
- Оставляем как есть (через SQL)
- Добавим UI позже

---

## 📊 ТЕКУЩИЙ СТАТУС

### ✅ ЧТО РАБОТАЕТ СЕЙЧАС:

- Backend полностью готов
- БД собирает все данные автоматически
- Функция пересчета репутации работает
- API endpoints готовы
- Модалки показываются игрокам

### ⚠️ ЧЕГО НЕТ (но данные есть):

- UI для просмотра своей репутации
- UI для админов (suspicious reports)
- Badge в профилях
- Публичное отображение репутации

### 🎯 Данные собираются, просмотр - через SQL/API

**Временное решение:** Админы могут смотреть через SQL (запросы выше)

**Постоянное решение:** Нужен UI (1-4 часа работы)

---

## ❓ ВАШ ВЫБОР:

**Что делаем?**

1. **"Создай UI для профиля"** → Добавлю вкладку "Репутация" (1 час)
2. **"Создай UI для админов"** → Вкладка "Feedbacks" в админ-панели (2-3 часа)
3. **"Создай всё"** → Полный UI (3-4 часа)
4. **"Пока хватит"** → Оставляем как есть, UI потом

**Что выбираете?** 🚀

