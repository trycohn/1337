const dotenv = require('dotenv');
const result = dotenv.config({ path: __dirname + '/.env' });

if (result.error) {
  console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ .env —Ñ–∞–π–ª–∞:', result.error);
} else {
  console.log('‚úÖ –§–∞–π–ª .env —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω');
}

console.log("üîç –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π JWT_SECRET:", process.env.JWT_SECRET ? '[–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω]' : '[–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç]');
console.log("üîç NODE_ENV:", process.env.NODE_ENV || '[–ù–µ —É–∫–∞–∑–∞–Ω–æ]');
console.log("üîç FACEIT_CLIENT_ID:", process.env.FACEIT_CLIENT_ID ? '[–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω]' : '[–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç]');
console.log("üîç FACEIT_CLIENT_SECRET:", process.env.FACEIT_CLIENT_SECRET ? '[–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω]' : '[–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç]');
console.log("üîç FACEIT_REDIRECT_URI:", process.env.FACEIT_REDIRECT_URI ? '[–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω]' : '[–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç]');

const express = require('express');
const morgan = require('morgan');
const cors = require('cors');
const helmet = require('helmet');
const path = require('path');
const rateLimiter = require('express-rate-limit');
const pool = require('./db');
const { authenticateToken } = require('./middleware/auth');
const { updateActivity } = require('./middleware/activity');
const http = require('http');
const puppeteer = require('puppeteer');
const cookieParser = require('cookie-parser');
const tournamentsRouter = require('./routes/tournaments');
const nodemailer = require('nodemailer');
const notifications = require('./notifications');
const { Server: SocketIOServer } = require('socket.io');
const { setupChatSocketIO } = require('./chat-socketio');

const app = express();
// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π
global.app = app;

const server = http.createServer(app);

// Middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ CORS –≤—Ä—É—á–Ω—É—é
app.use((req, res, next) => {
  const allowedOrigins = process.env.NODE_ENV === 'production'
      ? ['https://1337community.com', 'https://www.1337community.com']
      : ['http://localhost:3001', 'http://127.0.0.1:5500', 'http://localhost:3000'];
  const origin = req.headers.origin || 'https://1337community.com';
  console.log(`üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${req.method} ${req.path} –æ—Ç ${origin}`);
  console.log(`üîç –í—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞:`, req.headers);
  console.log(`üîç NODE_ENV –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: ${process.env.NODE_ENV}`);
  console.log(`üîç –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ origins: ${allowedOrigins}`);
  // –í—Ä–µ–º–µ–Ω–Ω–æ —Ä–∞–∑—Ä–µ—à–∞–µ–º –ª—é–±–æ–π origin –¥–ª—è —Ç–µ—Å—Ç–∞
  res.setHeader('Access-Control-Allow-Origin', origin || '*');
  console.log(`‚úÖ Origin ${origin} —Ä–∞–∑—Ä–µ—à—ë–Ω (–≤—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)`);
  res.setHeader('Access-Control-Allow-Methods', 'GET,HEAD,PUT,PATCH,POST,DELETE,OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  res.setHeader('Access-Control-Allow-Credentials', 'true');
  if (req.method === 'OPTIONS') {
      console.log(`üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ preflight-–∑–∞–ø—Ä–æ—Å–∞ (OPTIONS) –¥–ª—è ${req.path}`);
      return res.status(200).end();
  }
  next();
});

app.use((req, res, next) => {
    console.log(`üîç –í—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å: ${req.method} ${req.originalUrl}`);
    next();
});

app.use(express.json());
app.use(cookieParser());

// –î–æ–±–∞–≤–ª—è–µ–º middleware –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
app.use((req, res, next) => {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ Authorization
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];
  if (token) {
    // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—Å—Ç—å, –≤—ã–∑—ã–≤–∞–µ–º middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    return authenticateToken(req, res, () => {
      if (req.user) {
        updateActivity(req, res, next);
      } else {
        next();
      }
    });
  }
  next();
});

// –¢–µ—Å—Ç–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç
app.get('/testdb', async (req, res) => {
    try {
        const result = await pool.query('SELECT NOW()');
        res.json({ status: 'success', time: result.rows[0].now });
    } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ:', err);
        res.status(500).json({ status: 'error', message: err.message });
    }
});

app.get('/favicon.ico', (req, res) => res.status(204).end());
app.get('/favicon.png', (req, res) => res.status(204).end());

// API-–º–∞—Ä—à—Ä—É—Ç—ã
app.use('/api/users', require('./routes/users'));
app.use('/api/tournaments', tournamentsRouter);
app.use('/api/teams', require('./routes/teams'));
app.use('/api/tournamentPlayers', require('./routes/tournamentPlayers'));
app.use('/api/matches', require('./routes/matches'));
app.use('/api/statistics', require('./routes/statistics'));
app.use('/api/notifications', require('./routes/notifications'));
app.use('/api/playerStats', require('./routes/playerStats'));
app.use('/api/friends', require('./routes/friends'));
app.use('/api/chats', require('./routes/chats'));

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Socket.IO —Å–µ—Ä–≤–µ—Ä –¥–ª—è —á–∞—Ç–∞
const io = new SocketIOServer(server, {
  cors: {
    origin: [process.env.SERVER_URL || '*'],
    methods: ['GET', 'POST'],
    credentials: true
  }
});
setupChatSocketIO(io);

// –Ø –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ Socket.IO, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∞–ª–∏—Å—å –∫ —Å–≤–æ–∏–º –∫–æ–º–Ω–∞—Ç–∞–º
io.on('connection', (socket) => {
  console.log('Socket.IO Notifications: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è, userId =', socket.userId);
  socket.join(`user_${socket.userId}`);
  console.log(`Socket.IO Notifications: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${socket.userId} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ user_${socket.userId}`);

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞
  socket.on('watch_tournament', (tournamentId) => {
    socket.join(`tournament_${tournamentId}`);
    console.log(`Socket.IO Notifications: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${socket.userId} –ø–æ–¥–ø–∏—Å–∞–ª—Å—è –Ω–∞ —Ç—É—Ä–Ω–∏—Ä ${tournamentId}`);
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø–∏—Å–∫–∏ –æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Ç—É—Ä–Ω–∏—Ä–∞
  socket.on('unwatch_tournament', (tournamentId) => {
    socket.leave(`tournament_${tournamentId}`);
    console.log(`Socket.IO Notifications: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${socket.userId} –æ—Ç–ø–∏—Å–∞–ª—Å—è –æ—Ç —Ç—É—Ä–Ω–∏—Ä–∞ ${tournamentId}`);
  });
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
const mailTransporter = nodemailer.createTransport({
    host: process.env.SMTP_HOST,
    port: process.env.SMTP_PORT,
    secure: process.env.SMTP_PORT === '465',
    auth: {
        user: process.env.SMTP_USER,
        pass: process.env.SMTP_PASS
    }
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å SMTP-—Å–µ—Ä–≤–µ—Ä–æ–º
if (process.env.NODE_ENV !== 'test') {
    mailTransporter.verify((error, success) => {
        if (error) {
            console.warn('–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ SMTP-—Å–µ—Ä–≤–µ—Ä—É:', error);
        } else {
            console.log('SMTP-—Å–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π');
        }
    });
}

// Middleware
app.use(cors({
    origin: ['http://localhost:3000', 'https://1337community.com'], // –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è CORS
    credentials: true,
}));
app.use(express.json()); // –ü–∞—Ä—Å–∏–Ω–≥ JSON –≤ body
app.use(express.urlencoded({ extended: true })); // –ü–∞—Ä—Å–∏–Ω–≥ URL-encoded –≤ body

// –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ –ø–∞–ø–∫–∏ uploads
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));

// –ì–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã API
app.get('/', (req, res) => {
    res.json({ message: '–°–µ—Ä–≤–µ—Ä 1337 Community API —Ä–∞–±–æ—Ç–∞–µ—Ç!' });
});

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ middleware
app.use(helmet());
app.use(morgan('dev'));
app.use(cors());
app.use(express.json());

// –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
app.use(express.static(path.join(__dirname, 'public')));

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
const limiter = rateLimiter({
    windowMs: 15 * 60 * 1000, // 15 –º–∏–Ω—É—Ç
    max: 100 // –º–∞–∫—Å–∏–º—É–º 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ IP
});
app.use(limiter);

// –ú–∞—Ä—à—Ä—É—Ç—ã API
app.use('/api', (req, res) => {
    console.log(`404 –¥–ª—è –ø—É—Ç–∏: ${req.path}`);
    res.status(404).json({ error: 'API –º–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ 404
app.use((req, res) => {
    console.log(`404 –¥–ª—è –ø—É—Ç–∏: ${req.path}`);
    res.status(404).json({ error: '–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
app.use((err, req, res, next) => {
    console.error(err.stack);
    res.status(500).json({ message: "Internal Server Error" });
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
const PORT = process.env.PORT || 3000;
server.listen(PORT, async () => {
    console.log(`üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
    try {
        await pool.query('SELECT NOW()');
        console.log('‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
    } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:', err.message);
    }
});