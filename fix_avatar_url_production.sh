#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è URL –∞–≤–∞—Ç–∞—Ä–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ production
# –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç localhost URL –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–æ–º–µ–Ω

echo "üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï URL –ê–í–ê–¢–ê–†–ê –°–ò–°–¢–ï–ú–ù–û–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –í PRODUCTION"
echo "=============================================================="

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /var/www/1337community || {
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ /var/www/1337community"
    exit 1
}

echo "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é backend
cd backend || {
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é backend"
    exit 1
}

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è URL
cat > fix_avatar_url.js << 'EOF'
const pool = require('./db');

async function fixAvatarUrl() {
    try {
        console.log('üîÑ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL –∞–≤–∞—Ç–∞—Ä–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
        
        // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –¥–ª—è production
        const correctAvatarUrl = 'https://1337community.com/uploads/avatars/1337-logo-chat.png';
        
        // –ù–∞—Ö–æ–¥–∏–º —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userCheck = await pool.query('SELECT id, username, avatar_url FROM users WHERE username = $1', ['1337community']);
        
        if (userCheck.rows.length === 0) {
            console.log('‚ùå –°–∏—Å—Ç–µ–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1337community –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        const user = userCheck.rows[0];
        console.log(`üìã –ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.username}`);
        console.log(`üìã –¢–µ–∫—É—â–∏–π URL: ${user.avatar_url || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`);
        console.log(`üìã –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π URL: ${correctAvatarUrl}`);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        if (user.avatar_url === correctAvatarUrl) {
            console.log('‚úÖ URL –∞–≤–∞—Ç–∞—Ä–∞ —É–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π');
            return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º URL –∞–≤–∞—Ç–∞—Ä–∞
        await pool.query(
            'UPDATE users SET avatar_url = $1, updated_at = NOW() WHERE username = $2',
            [correctAvatarUrl, '1337community']
        );
        
        console.log('‚úÖ URL –∞–≤–∞—Ç–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        const updatedUser = await pool.query('SELECT avatar_url, updated_at FROM users WHERE username = $1', ['1337community']);
        const updated = updatedUser.rows[0];
        
        console.log(`‚úÖ –ù–æ–≤—ã–π URL: ${updated.avatar_url}`);
        console.log(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${updated.updated_at}`);
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ URL –∞–≤–∞—Ç–∞—Ä–∞:', error);
        throw error;
    } finally {
        await pool.end();
    }
}

fixAvatarUrl()
    .then(() => {
        console.log('üéâ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');
        process.exit(0);
    })
    .catch((error) => {
        console.error('üí• –û—à–∏–±–∫–∞:', error);
        process.exit(1);
    });
EOF

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
echo "üîÑ –ó–∞–ø—É—Å–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è URL –∞–≤–∞—Ç–∞—Ä–∞..."
NODE_ENV=production node fix_avatar_url.js
if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ URL –∞–≤–∞—Ç–∞—Ä–∞"
    exit 1
fi

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
rm -f fix_avatar_url.js

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd ..

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
echo ""
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
sudo systemctl restart 1337-backend
if [ $? -eq 0 ]; then
    echo "‚úÖ –°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å —á–µ—Ä–µ–∑ systemctl"
    echo "üîÑ –ü—ã—Ç–∞–µ–º—Å—è —á–µ—Ä–µ–∑ PM2..."
    pm2 restart 1337-backend 2>/dev/null || {
        echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ PM2"
        echo "üìã –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å –≤—Ä—É—á–Ω—É—é"
    }
fi

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∞–≤–∞—Ç–∞—Ä–∞
echo ""
echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∞–≤–∞—Ç–∞—Ä–∞..."
if command -v curl >/dev/null 2>&1; then
    HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://1337community.com/uploads/avatars/1337-logo-chat.png)
    if [ "$HTTP_STATUS" = "200" ]; then
        echo "‚úÖ –ê–≤–∞—Ç–∞—Ä –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ HTTPS (—Å—Ç–∞—Ç—É—Å: $HTTP_STATUS)"
    else
        echo "‚ùå –ê–≤–∞—Ç–∞—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ HTTPS (—Å—Ç–∞—Ç—É—Å: $HTTP_STATUS)"
    fi
else
    echo "‚ö†Ô∏è curl –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º HTTP –ø—Ä–æ–≤–µ—Ä–∫—É"
fi

echo ""
echo "üéâ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï URL –ê–í–ê–¢–ê–†–ê –ó–ê–í–ï–†–®–ï–ù–û!"
echo "===================================="
echo ""
echo "üìù –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:"
echo "1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω URL –∞–≤–∞—Ç–∞—Ä–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
echo "2. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª–µ updated_at –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞"
echo "3. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —Å–µ—Ä–≤–∏—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
echo "4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∞–≤–∞—Ç–∞—Ä–∞"
echo ""
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. ‚úÖ –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞ (Ctrl+F5)"
echo "2. ‚úÖ –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ"
echo "3. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á–∞—Ç - –∞–≤–∞—Ç–∞—Ä –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ URL"
echo ""
echo "üèÅ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–µ–Ω: $(date)" 